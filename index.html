<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Sakurazaka46 ç´€éŒ„ç”¢ç”Ÿå™¨ V5 - Pro Layout</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --sakura-pink: #f4b4d0; --text-gray: #8e8e93; --nick-green: #2ecc71; }
        body { font-family: -apple-system, "Helvetica Neue", sans-serif; background: #d1d1d6; display: flex; padding: 20px; gap: 20px; justify-content: center; }
        
        /* æ§åˆ¶é¢æ¿ */
        .controls { width: 340px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); height: 95vh; overflow-y: auto; font-size: 14px; }
        .controls h2 { margin: 0 0 15px 0; font-size: 1.1rem; border-left: 4px solid var(--sakura-pink); padding-left: 10px; }
        .input-group { margin-bottom: 12px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #555; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        
        .btn-area { display: flex; flex-direction: column; gap: 8px; margin-top: 15px; }
        button { cursor: pointer; padding: 10px; border: none; border-radius: 8px; font-weight: bold; transition: 0.2s; }
        .btn-member { background: #fff; color: #333; border: 1px solid #ddd; }
        .btn-fan { background: #efefef; color: #333; }
        .btn-save { background: #333; color: white; margin-top: 10px; }
        .btn-storage { background: #3498db; color: white; }

        /* é è¦½å€æ ¸å¿ƒ */
        #capture-area { 
            width: 450px; background: white; min-height: 800px; padding: 40px 30px; 
            position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; flex-direction: column;
        }
        #bg-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.1; z-index: 0; background-size: cover; pointer-events: none; }
        .content-layer { position: relative; z-index: 1; flex-grow: 1; }

        /* é ‚éƒ¨è³‡è¨Šï¼šå…¨éƒ¨ç½®ä¸­ */
        .header-center { text-align: center; margin-bottom: 30px; position: relative; padding-bottom: 20px; border-bottom: 1px solid #f2f2f7; }
        .header-avatar { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; margin-bottom: 15px; border: 2px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .header-name { font-size: 28px; font-weight: bold; color: #000; margin: 0; }
        .header-date { font-size: 14px; color: var(--text-gray); margin-top: 4px; }
        .header-nick { font-size: 20px; font-weight: bold; color: var(--nick-green); margin-top: 8px; }

        /* éƒ¨æ•¸è³‡è¨Šï¼šç¸®å°ç§»è‡³å³ä¸‹è§’ */
        .status-corner { position: absolute; right: 0; bottom: 5px; display: flex; gap: 10px; font-size: 12px; color: var(--text-gray); }
        .status-corner span { display: flex; align-items: center; gap: 3px; }

        /* å°è©±æ¨£å¼ */
        .chat-list { display: flex; flex-direction: column; gap: 10px; }
        .chat-item { display: flex; align-items: flex-start; position: relative; max-width: 90%; }
        .item-member { align-self: flex-start; }
        .item-fan { align-self: flex-end; flex-direction: row-reverse; }
        
        .chat-avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
        .item-member .chat-avatar { margin-right: 12px; }
        .item-fan .chat-avatar { margin-left: 12px; }

        .bubble { padding: 10px 16px; font-size: 15px; line-height: 1.5; border-radius: 18px; }
        .item-member .bubble { background: #fff; border: 1px solid #efeff4; border-top-left-radius: 4px; }
        .item-fan .bubble { background: #efefef; border-top-right-radius: 4px; }
        
        .no-avatar { margin-left: 57px; }
        .item-fan.no-avatar { margin-right: 57px; margin-left: 0; }

        .narration { text-align: center; color: #bbb; font-size: 13px; margin: 15px 0; font-style: italic; }
        .delete-btn { position: absolute; left: -25px; top: 12px; color: #ff3b30; cursor: pointer; font-weight: bold; display: none; }
        .chat-item:hover .delete-btn { display: block; }
    </style>
</head>
<body>

<div class="controls">
    <h2>âš™ï¸ ä»‹é¢èˆ‡å…§å®¹è¨­å®š</h2>
    <div class="input-group">
        <label>æˆå“¡å§“å</label>
        <input type="text" id="input-name" value="çŸ³æ£®ç’ƒèŠ±" oninput="updateUI()">
    </div>
    <div class="input-group">
        <label>ä½ çš„æš±ç¨± (é¡¯ç¤ºç‚ºç¶ è‰²å­—é«”)</label>
        <input type="text" id="input-nick" value="CoCo" oninput="updateUI()">
    </div>
    <div class="input-group">
        <label>æ—¥æœŸ</label>
        <input type="date" id="input-date" value="2026/01/10" oninput="updateUI()">
    </div>
    
    <div style="display: flex; gap: 5px;">
        <div class="input-group"><label>éƒ¨æ•¸</label><input type="text" id="input-part" value="ç¬¬3éƒ¨" oninput="updateUI()"></div>
        <div class="input-group"><label>æšæ•¸</label><input type="number" id="input-cards" value="3" oninput="updateUI()"></div>
        <div class="input-group"><label>ç§’æ•¸</label><input type="number" id="input-seconds" value="30" oninput="updateUI()"></div>
    </div>

    <hr>
    <div class="btn-area">
        <button class="btn-storage" onclick="saveToLocal()">ğŸ’¾ å„²å­˜ç•¶å‰è‰ç¨¿</button>
        <button class="btn-storage" style="background:#95a5a6;" onclick="loadFromLocal()">ğŸ“‚ è®€å–ä¸Šæ¬¡å­˜æª”</button>
    </div>

    <hr>
    <div class="input-group"><label>é ­åƒ/èƒŒæ™¯ (é¸å®Œå¾Œæœƒè‡ªå‹•è¼‰å…¥)</label>
        <input type="file" id="up-member" onchange="previewFile('member')" style="margin-bottom:5px;">
        <input type="file" id="up-fan" onchange="previewFile('fan')" style="margin-bottom:5px;">
        <input type="file" id="up-bg" onchange="previewFile('bg')">
    </div>

    <hr>
    <div class="input-group"><label>è¼¸å…¥å°è©±æ–‡å­—</label><textarea id="input-msg" rows="3"></textarea></div>
    <div class="btn-area">
        <button class="btn-member" onclick="addChat('member')">+ æˆå“¡ç™¼è¨€</button>
        <button class="btn-fan" onclick="addChat('fan')">+ æˆ‘ç™¼è¨€</button>
        <button style="background:#eee;" onclick="addChat('note')">+ åŠ å…¥ç­†è¨˜</button>
        <button class="btn-save" onclick="saveImage()">ğŸ“¸ å°å‡ºé«˜æ¸…ä¸å£“ç¸®æˆªåœ–</button>
    </div>
</div>

<div id="capture-area">
    <div id="bg-overlay"></div>
    <div class="content-layer">
        <div class="header-center">
            <img src="https://via.placeholder.com/150" id="prev-img-member" class="header-avatar">
            <div id="prev-name" class="header-name">çŸ³æ£®ç’ƒèŠ±</div>
            <div id="prev-date" class="header-date">2026/01/10</div>
            <div style="font-size: 12px; color: #333; margin-top: 10px;">ğŸ‘¤ ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </div>
            <div id="prev-nick" class="header-nick">CoCo</div>
            
            <div class="status-corner">
                <span id="prev-part">ç¬¬3éƒ¨</span>
                <span>ğŸ«<span id="prev-cards">3</span></span>
                <span>â±ï¸<span id="prev-seconds">30</span></span>
            </div>
        </div>

        <div class="chat-list" id="chat-list"></div>
    </div>
</div>

<script>
    let memberAvatar = "https://via.placeholder.com/150";
    let fanAvatar = "https://via.placeholder.com/150";
    let lastType = "";

    function updateUI() {
        document.getElementById('prev-name').innerText = document.getElementById('input-name').value;
        // --- æ—¥æœŸæ ¼å¼åŒ–è™•ç† ---
    const rawDate = document.getElementById('input-date').value; // æ ¼å¼é€šå¸¸æ˜¯ YYYY-MM-DD
    if (rawDate) {
        const dateObj = new Date(rawDate);
        const month = dateObj.getMonth() + 1; // æœˆä»½å¾0é–‹å§‹
        const date = dateObj.getDate();
        const dayList = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        const dayOfWeek = dayList[dateObj.getDay()];
        
        // çµ„åˆæˆ 1/10(å…­) æ ¼å¼
        document.getElementById('prev-date').innerText = `${month}/${date}(${dayOfWeek})`;
    }
        document.getElementById('prev-nick').innerText = document.getElementById('input-nick').value;
        document.getElementById('prev-part').innerText = document.getElementById('input-part').value;
        document.getElementById('prev-cards').innerText = document.getElementById('input-cards').value;
        document.getElementById('prev-seconds').innerText = document.getElementById('input-seconds').value;
    }

    function previewFile(type) {
        const file = document.getElementById(`up-${type}`).files[0];
        const reader = new FileReader();
        reader.onloadend = () => {
            if (type === 'member') { memberAvatar = reader.result; document.getElementById('prev-img-member').src = reader.result; }
            else if (type === 'fan') { fanAvatar = reader.result; }
            else { document.getElementById('bg-overlay').style.backgroundImage = `url(${reader.result})`; }
        };
        if (file) reader.readAsDataURL(file);
    }

    function addChat(type) {
        const msg = document.getElementById('input-msg').value;
        if (!msg && type !== 'note') return;
        const list = document.getElementById('chat-list');
        const div = document.createElement('div');
        
        if (type === 'note') {
            div.className = 'narration';
            div.innerText = msg;
            lastType = "note";
        } else {
            const isContinuous = (type === lastType);
            div.className = `chat-item item-${type} ${isContinuous ? 'no-avatar' : ''}`;
            const avatarHtml = isContinuous ? '' : `<img src="${type === 'member' ? memberAvatar : fanAvatar}" class="chat-avatar">`;
            
            div.innerHTML = `
                <span class="delete-btn" onclick="this.parentElement.remove()">Ã—</span>
                ${avatarHtml}
                <div class="bubble">${msg.replace(/\n/g, '<br>')}</div>
            `;
            lastType = type;
        }
        list.appendChild(div);
        document.getElementById('input-msg').value = '';
    }

    // å­˜æª”åŠŸèƒ½ï¼šå°‡æ–‡å­—è³‡è¨Šå­˜å…¥ç€è¦½å™¨å¿«å–
    function saveToLocal() {
        const data = {
            name: document.getElementById('input-name').value,
            nick: document.getElementById('input-nick').value,
            date: document.getElementById('input-date').value,
            part: document.getElementById('input-part').value,
            cards: document.getElementById('input-cards').value,
            seconds: document.getElementById('input-seconds').value,
            chats: document.getElementById('chat-list').innerHTML
        };
        localStorage.setItem('meguri_save', JSON.stringify(data));
        alert('å­˜æª”æˆåŠŸï¼');
    }

    // è®€å–åŠŸèƒ½
    function loadFromLocal() {
        const saved = localStorage.getItem('meguri_save');
        if (saved) {
            const data = JSON.parse(saved);
            document.getElementById('input-name').value = data.name;
            document.getElementById('input-nick').value = data.nick;
            document.getElementById('input-date').value = data.date;
            document.getElementById('input-part').value = data.part;
            document.getElementById('input-cards').value = data.cards;
            document.getElementById('input-seconds').value = data.seconds;
            document.getElementById('chat-list').innerHTML = data.chats;
            updateUI();
            alert('è®€å–å®Œæˆï¼');
        } else {
            alert('æ²’æœ‰æ‰¾åˆ°å­˜æª”ç´€éŒ„ã€‚');
        }
    }

    // å°å‡ºæˆªåœ–ï¼šå„ªåŒ–ä¸å£“ç¸®
    function saveImage() {
        const target = document.querySelector("#capture-area");
        const btns = document.querySelectorAll('.delete-btn');
        btns.forEach(b => b.style.display = 'none');

        html2canvas(target, { 
            scale: 4, // æé«˜è§£æåº¦è§£æ±ºæ¨¡ç³Šå•é¡Œ
            useCORS: true, 
            backgroundColor: "#ffffff",
            imageTimeout: 0
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = `Sakurazaka_Meguri_${document.getElementById('input-name').value}.png`;
            link.href = canvas.toDataURL("image/png", 1.0);
            link.click();
            btns.forEach(b => b.style.display = 'block');
        });
    }
</script>

</body>
</html>