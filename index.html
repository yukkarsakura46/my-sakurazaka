<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>üå∏ Ê´ªÂùÇ46 Collection</title>

    <!-- Vue 3 -->
    <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js"></script>
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        * {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans TC",
                sans-serif !important;
            text-transform: none !important;
            box-sizing: border-box;
        }

        [v-cloak] {
            display: none;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            width: 100%;
        }

        .series-photo-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
            width: 100%;
            max-width: 170px;
        }

        .item-slot {
            aspect-ratio: 2 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 800;
            transition: all 0.2s;
        }

        .section-header {
            font-size: 14px;
            font-weight: 900;
            color: #64748b;
            margin: 20px 0 10px 4px;
            border-left: 3px solid #f472b6;
            padding-left: 8px;
            text-transform: uppercase;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .group-tag {
            font-size: 8px;
            background: #fee2e2;
            color: #ef4444;
            padding: 1px 4px;
            border-radius: 4px;
            margin-left: 5px;
            font-weight: bold;
        }

        .tab-btn {
            font-size: 11px;
            font-weight: 900;
            padding: 6px 16px;
            border-radius: 99px;
        }

        .tab-active {
            background: #f472b6;
            color: white;
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen">
<div id="app" v-cloak>
    <!-- NAV -->
    <nav
        class="bg-white shadow-sm p-4 sticky top-0 z-30 flex justify-between items-center border-b"
    >
        <h1
            class="text-xl font-black text-gray-800 cursor-pointer"
            @click="currentMember = null; viewMode = 'member'"
        >
            üå∏ Ê´ªÂùÇ46
        </h1>
        <button
            @click="showInput = true"
            class="text-[10px] bg-slate-800 text-white px-4 py-2 rounded-full font-bold shadow-lg"
        >
            ÁÆ°ÁêÜÈù¢Êùø
        </button>
    </nav>

    <!-- ÁÆ°ÁêÜÈù¢Êùø -->
    <div v-if="showInput" class="modal-overlay" @click.self="showInput = false">
        <div
            class="bg-white w-full max-w-sm p-6 rounded-3xl shadow-2xl border-t-4 border-pink-400 relative overflow-y-auto max-h-[90vh]"
        >
            <button
                @click="showInput = false"
                class="absolute top-4 right-4 text-gray-300 font-bold"
            >
                ‚úï
            </button>
            <h3 class="text-base font-black text-gray-800 mb-4">Ë≥áÊñôÁÆ°ÁêÜ</h3>

            <div class="flex bg-slate-100 p-1 rounded-xl mb-4 text-[10px] font-bold">
                <button
                    @click="addMode='member'"
                    class="flex-1 py-2 rounded-lg"
                    :class="addMode==='member' ? 'bg-white shadow text-pink-500' : ''"
                >
                    ÊåâÊàêÂì°
                </button>
                <button
                    @click="addMode='series'"
                    class="flex-1 py-2 rounded-lg"
                    :class="addMode==='series' ? 'bg-white shadow text-pink-500' : ''"
                >
                    ÊåâÁ≥ªÂàó
                </button>
            </div>

            <div class="space-y-3 text-xs text-gray-700">
                <!-- ÊåâÊàêÂì°Êñ∞Â¢û -->
                <template v-if="addMode === 'member'">
                    <select
                        v-model="selectedGen"
                        class="w-full border p-2.5 rounded-xl bg-white font-bold"
                    >
                        <option value="">-- ÊúüÂà• --</option>
                        <option v-for="(ms, g) in presetMembers" :value="g">{{g}}</option>
                    </select>

                    <select
                        v-if="selectedGen"
                        v-model="newItem.name"
                        class="w-full border p-2.5 rounded-xl bg-white font-bold"
                    >
                        <option v-for="n in presetMembers[selectedGen]" :value="n">
                            {{n}}
                        </option>
                    </select>

                    <select
                        v-model="selectedCategory"
                        @change="onCategorySelect"
                        class="w-full border p-2.5 rounded-xl bg-white"
                    >
                        <option value="">-- ÂàÜÈ°û --</option>
                        <option
                            v-for="(list, cat) in categorizedSeries"
                            :key="cat"
                            :value="cat"
                        >
                            {{cat}}
                        </option>
                        <option value="custom_cat">Ôºã Ëá™ÂÆöÁæ©</option>
                    </select>

                    <select
                        v-if="selectedCategory"
                        v-model="selectedPreset"
                        @change="onSeriesSelect"
                        class="w-full border p-2.5 rounded-xl bg-white"
                    >
                        <option value="">-- Á≥ªÂàó --</option>
                        <option
                            v-for="s in categorizedSeries[selectedCategory]"
                            :value="s"
                        >
                            {{s}}
                        </option>
                        <option value="custom_series">Ôºã ÊâãÂãïËº∏ÂÖ•</option>
                    </select>
                </template>

                <!-- ÊåâÁ≥ªÂàóÊñ∞Â¢û -->
                <template v-else>
                    <select
                        v-model="selectedCategory"
                        @change="onCategorySelect"
                        class="w-full border p-2.5 rounded-xl bgÁôΩ"
                    >
                        <option value="">-- ÂàÜÈ°û --</option>
                        <option
                            v-for="(list, cat) in categorizedSeries"
                            :value="cat"
                        >
                            {{cat}}
                        </option>
                    </select>

                    <select
                        v-if="selectedCategory"
                        v-model="selectedPreset"
                        @change="onSeriesSelect"
                        class="w-full border p-2.5 rounded-xl bg-white"
                    >
                        <option value="">-- Á≥ªÂàó --</option>
                        <option
                            v-for="s in categorizedSeries[selectedCategory]"
                            :value="s"
                        >
                            {{s}}
                        </option>
                    </select>

                    <select
                        v-if="selectedPreset"
                        v-model="selectedGen"
                        class="w-full border p-2.5 rounded-xl bg-white font-bold"
                    >
                        <option value="">-- ÊúüÂà• --</option>
                        <option
                            v-for="(ms, g) in presetMembers"
                            :value="g"
                        >
                            {{g}}
                        </option>
                    </select>

                    <div
                        v-if="selectedGen && selectedPreset"
                        class="border rounded-xl p-3 bg-slate-50 max-h-40 overflow-y-auto"
                    >
                        <div
                            v-for="n in presetMembers[selectedGen]"
                            class="flex items-center mb-1"
                        >
                            <input
                                type="checkbox"
                                :value="n"
                                v-model="batchMemberNames"
                                class="mr-2 accent-pink-500"
                            />
                            <span>{{n}}</span>
                        </div>
                    </div>
                </template>

                <input
                    v-if="selectedCategory === 'custom_cat'"
                    v-model="newItem.category"
                    type="text"
                    placeholder="ÊâãÂãïÂàÜÈ°û"
                    class="w-full border p-2.5 rounded-xl"
                />

                <input
                    v-if="selectedPreset === 'custom_series' || selectedCategory === 'custom_cat'"
                    v-model="newItem.series"
                    type="text"
                    placeholder="ÊâãÂãïÁ≥ªÂàó"
                    class="w-full border p-2.5 rounded-xl"
                />

                <button
                    @click="addBatchItems"
                    class="w-full bg-pink-500 textÁôΩ p-3 rounded-xl font-bold shadow-lg"
                >
                    Á¢∫Ë™çÊñ∞Â¢û
                </button>
            </div>

            <!-- ÂÇô‰ªΩ / ÈÇÑÂéü / Ê∏ÖÁ©∫ -->
            <div class="flex items-center justify-between mt-8 border-t pt-4">
                <div class="flex gap-3 items-center">
                    <!-- ÈÇÑÂéüË≥áÊñô -->
                    <label
                        class="text-emerald-500 font-bold text-xs cursor-pointer"
                    >
                        ÈÇÑÂéüË≥áÊñô
                        <input
                            type="file"
                            class="hidden"
                            accept=".txt,.json,application/json,text/plain"
                            @change="importDataFromFile"
                        />
                    </label>
                    <!-- ÂÇô‰ªΩË≥áÊñô -->
                    <button
                        @click="exportData"
                        class="text-blue-500 font-bold text-xs"
                    >
                        ÂÇô‰ªΩË≥áÊñô
                    </button>
                </div>
                <button
                    @click="clearAll"
                    class="text-red-300 font-bold text-xs"
                >
                    Ê∏ÖÁ©∫
                </button>
            </div>
        </div>
    </div>

    <!-- MAIN -->
    <main class="max-w-xl mx-auto p-3">
        <!-- Ê®°ÂºèÂàáÊèõ -->
        <div
            v-if="!currentMember"
            class="flex justify-center items-center gap-4 my-4"
        >
            <button
                @click="viewMode = 'member'"
                class="tab-btn"
                :class="viewMode === 'member' ? 'tab-active' : 'text-slate-400'"
            >
                ÊàêÂì°Ê®°Âºè
            </button>
            <button
                @click="viewMode = 'series'"
                class="tab-btn"
                :class="viewMode === 'series' ? 'tab-active' : 'text-slate-400'"
            >
                Á≥ªÂàóÊ®°Âºè
            </button>
        </div>

        <!-- ÊàêÂì°Ê®°ÂºèÔºöÊàêÂì°ÂàóË°® -->
        <div v-if="!currentMember && viewMode === 'member'">
            <div v-for="(ms, g) in presetMembers" :key="g">
                <div v-if="getActiveMembersInGen(g).length > 0">
                    <h2 class="section-header">{{ g }}</h2>
                    <div class="grid grid-cols-2 gap-3">
                        <div
                            v-for="name in getActiveMembersInGen(g)"
                            :key="g + '-' + name"
                            @click="currentMember = name"
                            class="bg-white p-5 rounded-2xl shadow-sm text-center cursor-pointer"
                        >
                            <div class="font-black text-gray-700">
                                {{ name }}
                            </div>
                            <div
                                class="text-[8px] font-bold text-pink-400"
                            >
                                {{ getMemberOwnedCount(name) }} Collected
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div
                v-if="memberList.length === 0"
                class="text-center py-24 text-slate-300 font-bold italic"
            >
                ÁõÆÂâçÂ∞öÁÑ°Êî∂ËóèË≥áÊñô
            </div>
        </div>

        <!-- Á≥ªÂàóÊ®°Âºè -->
        <div v-if="!currentMember && viewMode === 'series'">
            <div v-for="(seriesObj, catName) in itemsBySeriesNormalized" :key="catName">
                <!-- ÂèØÊî∂ÂêàÁöÑÂ§ßÂàÜÈ°ûÔºàÁ≥ªÂàóÊ®°ÂºèÔºâ -->
                <h2
                    class="section-header flex items-center justify-between pr-4 cursor-pointer"
                    @click="toggleCategory(catName)"
                >
                    <span>{{ catName }}</span>
                    <span class="text-[10px] text-slate-400">
                        {{ collapsedCategories.has(catName) ? 'Ôºã Â±ïÈñã' : 'Ôºç Êî∂Âêà' }}
                    </span>
                </h2>

                <div v-if="!collapsedCategories.has(catName)">
                    <div
                        v-for="(batches, seriesName) in seriesObj"
                        :key="catName + '-' + seriesName"
                        :id="'series-target-' + seriesName"
                        class="mb-2 bg-white rounded-2xl shadow-sm border overflow-hidden"
                    >
                        <div
                            @click="toggleSeriesMode(catName, seriesName)"
                            class="px-4 py-3 flex justify-between items-center cursor-pointer"
                        >
                            <div class="flex items-center min-w-0">
                              <span
                                class="font-black text-gray-600 text-[10px] truncate max-w-full"
                                :title="seriesName"
                              >
                                {{ seriesName }}
                              </span>
                            </div>

                            <!-- Âè≥ÂÅ¥ÔºöÊàêÂì°Êï∏ -->
                            <div class="text-[9px] font-bold text-pink-400 shrink-0">
                              {{ getUniqueMemberCount(batches) }} Member(s)
                            </div>
                        </div>

                        <div
                            v-if="expandedSeriesMode.has(catName + seriesName)"
                            class="p-3 border-t bg-slate-50/50 space-y-3"
                        >
                            <div
  v-for="b in batches"
  :key="b.batchId"
  class="flex items-center gap-4 py-2 border-b border-gray-50 last:border-0"
>
  <!-- Â∑¶ÔºöÊàêÂì°ÂêçÁ®± + SETÔºàÁµ¶Âõ∫ÂÆöÂØ¨Â∫¶ÔºåÈÅøÂÖçÊíêÂà∞‰∏≠ÈñìÔºâ -->
  <div
    @click="currentMember = b.memberName"
    class="text-[11px] font-bold min-w-[80px] max-w-[80px] cursor-pointer flex items-center"
  >
    <span class="truncate">{{ b.memberName }}</span>
    <span
      v-if="b.totalSets > 1"
      class="group-tag ml-1 shrink-0"
    >
      SET {{ b.groupIndex }}
    </span>
  </div>

  <!-- ‰∏≠Ôºö4 ÂÄãÊ†ºÂ≠êÔºàÂõ∫ÂÆöÂØ¨Â∫¶ÔºåÊâÄÊúâÂàóÈÉΩ‰∏ÄÊ®£ÂØ¨Ôºâ -->
  <div class="series-photo-grid w-[160px] shrink-0">
    <div
      v-for="item in b.items"
      :key="item.id"
      @click="toggleItem(item.id)"
      class="item-slot border cursor-pointer"
      :class="ownedIds.has(item.id)
              ? 'bg-pink-500 border-pink-500 text-white'
              : 'bg-white text-gray-200'"
    >
      {{ item.type }}
    </div>
  </div>

  <!-- Âè≥ÔºöÈÄ≤Â∫¶ÊñáÂ≠óÔºàÂõ∫ÂÆöÂØ¨Â∫¶Ôºå‰∏çÊúÉÊì†Âà∞‰∏≠ÈñìÔºâ -->
  <div
    class="text-[9px] font-black text-right w-[40px] shrink-0"
    :class="getProgress(b.items).count===4 ? 'text-green-500' : 'text-pink-400'"
  >
    {{ getProgress(b.items).count===4 ? 'Complete' : getProgress(b.items).count + '/4' }}
  </div>
</div>

                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÊàêÂì°Ë©≥Á¥∞È†Å -->
        <div v-if="currentMember">
            <div class="flex items-center justify-between mb-6 px-1">
                <div class="flex items-center gap-2">
                    <button
                        @click="currentMember = null"
                        class="text-gray-300 font-bold text-2xl px-2"
                    >
                        ‚Äπ
                    </button>
                    <div class="relative">
                        <select
                            v-model="currentMember"
                            class="appearance-none bg-transparent font-black text-2xl outline-none pr-8 cursor-pointer"
                        >
                            <optgroup
                                v-for="(names, gen) in presetMembers"
                                :key="gen"
                                :label="gen"
                            >
                                <option
                                    v-for="name in getActiveMembersInGen(gen)"
                                    :key="gen + '-' + name"
                                    :value="name"
                                >
                                    {{ name }}
                                </option>
                            </optgroup>
                        </select>
                        <div
                            class="pointer-events-none absolute inset-y-0 right-0 flex items-center text-pink-500"
                        >
                            ‚ñº
                        </div>
                    </div>
                </div>
            </div>

            <div
                v-for="catBlock in memberItemsGrouped"
                :key="catBlock.category"
                class="mb-8"
            >
                <!-- ÂèØÊî∂ÂêàÁöÑÂ§ßÂàÜÈ°ûÔºàÊàêÂì°Ê®°ÂºèÔºâ -->
                <h2
                    class="section-header flex items-center justify-between pr-4 cursor-pointer"
                    @click="toggleMemberCategory(catBlock.category)"
                >
                    <span>{{ catBlock.category }}</span>
                    <span class="text-[10px] text-slate-400">
                        {{ memberCollapsedCategories.has(catBlock.category) ? 'Ôºã Â±ïÈñã' : 'Ôºç Êî∂Âêà' }}
                    </span>
                </h2>

                <div v-if="!memberCollapsedCategories.has(catBlock.category)">
                    <div
                        v-for="batch in catBlock.items"
                        :key="batch.batchId"
                        :id="'batch-target-' + batch.batchId"
                        class="mb-2.5 bg-white rounded-xl shadow-sm border overflow-hidden"
                    >
                        <!-- Ê®ôÈ°åÂàóÔºöÁ≥ªÂàóÂêçÁ®± + ÈÄ≤Â∫¶ + Âà™Èô§Èçµ -->
                        <div
                            class="p-4 flex justify-between items-center cursor-pointer"
                            @click="toggleSeries(batch.batchId)"
                        >
                            <!-- Â∑¶ÂÅ¥ÔºöÁ≥ªÂàóÂêçÁ®± -->
                            <div class="flex items-center gap-1 min-w-0">
                             <!-- Á≥ªÂàóÂêçÁ®±ÔºöÂñÆË°åÁúÅÁï• -->
                             <span
                               class="font-bold text-xs text-gray-700 truncate max-w-full"
                               title="{{ batch.seriesName }}"
                             >
                               {{ batch.seriesName }}
                             </span>

                             <!-- SET Ê®ôÁ±§ -->
                             <span
                               v-if="batch.totalSets > 1"
                               class="group-tag shrink-0"
                             >
                               SET {{ batch.groupIndex }}
                             </span>
                           </div>

                            <!-- Âè≥ÂÅ¥ÔºöÈÄ≤Â∫¶ + Âà™Èô§ -->
                            <div class="flex items-center gap-2">
                                <!-- ÈÄ≤Â∫¶Ôºö1/4 Êàñ CompleteÔºà‰∏çÈúÄÂ±ïÈñãÔºâ -->
                                <span
                                    class="text-[9px] font-black"
                                    :class="getProgress(batch.items).count===4 ? 'text-green-500' : 'text-pink-400'"
                                    @click.stop
                                >
                                    {{ getProgress(batch.items).count===4 ? 'Complete' : getProgress(batch.items).count + '/4' }}
                                </span>

                                <!-- Âà™Èô§Èçµ -->
                                <button
                                    @click.stop="removeSeries(batch.batchId)"
                                    class="text-red-200"
                                >
                                    ‚úï
                                </button>
                            </div>
                        </div>

                        <!-- Â±ïÈñãÂæåÂÖßÂÆπ -->
                        <div
                            v-if="expandedSeries.has(batch.batchId)"
                            class="p-4 border-t bg-slate-50/20"
                        >
                            <div
                                class="mb-4 relative aspect-video bg-slate-100 rounded-xl overflow-hidden group"
                            >
                                <template v-if="seriesImages[batch.batchId]">
                                    <img
                                        :src="seriesImages[batch.batchId]"
                                        @click="zoomedImg = seriesImages[batch.batchId]"
                                        class="w-full h-full object-contain cursor-zoom-in"
                                    />
                                    <button
                                        @click.stop="removeImage(batch.batchId)"
                                        class="absolute top-2 right-2 bg-red-500/80 text-white w-6 h-6 rounded-full flex items-center justify-center text-[10px]"
                                    >
                                        ‚úï
                                    </button>
                                </template>
                                <label
                                    v-else
                                    class="w-full h-full flex items-center justify-center cursor-pointer text-[10px] text-slate-400"
                                >
                                    + ‰∏äÂÇ≥ÂúñÁâá
                                    <input
                                        type="file"
                                        class="hidden"
                                        @change="(e) => handleSeriesImageUpload(e, batch.batchId)"
                                        accept="image/*"
                                    />
                                </label>
                            </div>

                            <div class="photo-grid">
                                <div
                                    v-for="item in batch.items"
                                    :key="item.id"
                                    @click="toggleItem(item.id)"
                                    class="item-slot border-2 cursor-pointer"
                                    :class="ownedIds.has(item.id)
                                            ? 'border-pink-500 bg-pink-500 text-white'
                                            : 'border-gray-100 bg-white text-gray-300'"
                                >
                                    {{ item.type }}
                                </div>
                            </div>
                            <!-- Â±ïÈñãÂçÄÂ°äË£°Â∞±‰∏çÁî®ÂÜçÈ°ØÁ§∫ÈÄ≤Â∫¶ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- ÂúñÁâáÊîæÂ§ß -->
    <div
        v-if="zoomedImg"
        @click="zoomedImg = null"
        class="fixed inset-0 bg-black/95 z-[200] flex items-center justify-center p-2"
    >
        <img :src="zoomedImg" class="max-w-full max-h-full object-contain" />
    </div>
</div>

<!-- APP SCRIPT -->
<script>
    (function () {
        const { createApp, nextTick } = window.Vue || {};

        if (!createApp) {
            console.error("Vue Ê≤íÊúâÊ≠£Á¢∫ËºâÂÖ•ÔºåË´ãÊ™¢Êü• CDN„ÄÇ");
            return;
        }

        // --- Á∞°ÂñÆÁöÑ IndexedDB key-value Â∞ÅË£ù ---
        function createStorage() {
  if (!("indexedDB" in window)) {
    console.warn(
      "Ê≠§Ë£ùÁΩÆ‰∏çÊîØÊè¥ IndexedDBÔºåÂ∞á‰ΩøÁî® localStorageÔºåÂúñÁâáÂÆπÈáèÂèØËÉΩËºÉÂ∞è„ÄÇ"
    );
    const PREFIX = "sakura_kv_";
    return {
      async get(key) {
        try {
          const raw = localStorage.getItem(PREFIX + key);
          return raw ? JSON.parse(raw) : null;
        } catch (e) {
          console.error("localStorage get ÈåØË™§Ôºö", e);
          return null;
        }
      },
      async set(key, value) {
        try {
          localStorage.setItem(PREFIX + key, JSON.stringify(value));
        } catch (e) {
          console.error("localStorage set ÈåØË™§Ôºö", e);
        }
      },
      async clear() {
        try {
          Object.keys(localStorage).forEach((k) => {
            if (k.startsWith(PREFIX)) {
              localStorage.removeItem(k);
            }
          });
        } catch (e) {
          console.error("localStorage clear ÈåØË™§Ôºö", e);
        }
      },
    };
  }

  const DB_NAME = "sakura_collection_db";
  const STORE_NAME = "kv";

  function openDB() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, 1);
      req.onupgradeneeded = (event) => {
        const db = event.target.result;
        if (!db.objectStoreNames.contains(STORE_NAME)) {
          db.createObjectStore(STORE_NAME);
        }
      };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }

  console.log("‰ΩøÁî® IndexedDB ÂÑ≤Â≠òË≥áÊñô„ÄÇ");

  return {
    async get(key) {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, "readonly");
        const store = tx.objectStore(STORE_NAME);
        const req = store.get(key);
        req.onsuccess = () => {
          const raw = req.result;
          if (typeof raw === "string") {
            // ÊàëÂÄëËá™Â∑±Â≠òÈÄ≤ÂéªÁöÑ JSON Â≠ó‰∏≤
            try {
              resolve(JSON.parse(raw));
            } catch (e) {
              console.error("Ëß£Êûê IndexedDB JSON Â§±ÊïóÔºö", e);
              resolve(null);
            }
          } else {
            // Â¶ÇÊûúÊòØËàäÁâàÁõ¥Êé•Â≠òÁâ©‰ª∂ÁöÑË≥áÊñôÔºåÂ∞±ÂÖàÁÖßÂéüÊ®£ÂõûÂÇ≥Ôºà‰πãÂæåÊ∏ÖÊéâÂç≥ÂèØÔºâ
            resolve(raw ?? null);
          }
        };
        req.onerror = () => reject(req.error);
      });
    },

    async set(key, value) {
      const db = await openDB();
      let payload;
      try {
        // ‰∏ÄÂæãËΩâÊàê JSON Â≠ó‰∏≤Â≠ò
        payload = JSON.stringify(value);
      } catch (e) {
        console.error("Ê∫ñÂÇôÂØ´ÂÖ• IndexedDB ÊôÇ JSON Â∫èÂàóÂåñÂ§±ÊïóÔºö", e);
        throw e;
      }

      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, "readwrite");
        const store = tx.objectStore(STORE_NAME);
        const req = store.put(payload, key); // ‚úÖ Ê∞∏ÈÅ†ÊòØ stringÔºå‰∏çÊúÉÂÜç DataCloneError
        req.onsuccess = () => resolve();
        req.onerror = () => reject(req.error);
      });
    },

    async clear() {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, "readwrite");
        const store = tx.objectStore(STORE_NAME);
        const req = store.clear();
        req.onsuccess = () => resolve();
        req.onerror = () => reject(req.error);

      });
    },
  };
}
const { get, set, clear } = createStorage();
        // --- Vue App ---
        createApp({
            data() {
                return {
                    viewMode: "member",
                    addMode: "member",
                    showInput: false,
                    currentMember: null,
                    selectedGen: "",
                    selectedCategory: "",
                    selectedPreset: "",
                    batchMemberNames: [],
                    presetMembers: {"‰∫åÊúüÁîü": ["ÈÅ†Ëó§ÂÖâËéâ", "Â§ßÂúíÁé≤", "Â§ßÊ≤ºÊô∂‰øù", "Âπ∏Èò™ËåâÈáå‰πÉ", "Ê≠¶ÂÖÉÂîØË°£", "Áî∞Êùë‰øù‰πÉ", "Ëó§ÂêâÂ§èÈà¥", "Â¢óÊú¨Á∂∫ËâØ", "ÊùæÁî∞ÈáåÂ•à", "Ê£ÆÁî∞„Å≤„Åã„Çã", "ÂÆàÂ±ãÈ∫óÂ•à", "Â±±Ô®ëÂ§©"], "‰∏âÊúüÁîü": ["Áü≥Ê£ÆÁíÉËä±", "ÈÅ†Ëó§ÁêÜÂ≠ê", "Â∞èÁî∞ÂÄâÈ∫óÂ•à", "Â∞èÂ≥∂Âá™Á¥ó", "Ë∞∑Âè£ÊÑõÂ≠£", "‰∏≠Â∂ãÂÑ™Êúà", "ÁöÑÈáéÁæéÈùí", "Âêë‰∫ïÁ¥îËëâ", "Êùë‰∫ïÂÑ™", "ÊùëÂ±±ÁæéÁæΩ", "Â±±‰∏ãÁû≥Êúà"], "ÂõõÊúüÁîü": ["ÊµÖ‰∫ïÊÅã‰πÉÊú™", "Á®≤ÁÜä„Å≤„Å™", "ÂãùÂèàÊò•", "‰ΩêËó§ÊÑõÊ°ú", "‰∏≠Â∑ùÊô∫Â∞ã", "ÊùæÊú¨ÂíåÂ≠ê", "ÁõÆÈªíÈôΩËâ≤", "Â±±Â∑ùÂÆáË°£", "Â±±Áî∞Ê°ÉÂÆü"], "Áï¢Ê•≠Áîü": ["ÊùæÂπ≥ÁíÉÂ≠ê", "ÂÆàÂ±ãËåú", "Ê∏°ÈÇâÊ¢®Âä†", "Ê∏°ÈÇâÁêÜ‰Ωê", "ÂéüÁî∞Ëëµ", "Â∞æÈñ¢Ê¢®È¶ô", "ËèÖ‰∫ïÂèãÈ¶ô", "Èñ¢ÊúâÁæéÂ≠ê", "ÂúüÁîüÁëûÁ©Ç", "Â∞èÊûóÁî±‰æù", "ÈΩãËó§ÂÜ¨ÂÑ™Ëä±", "‰∏äÊùëËéâËèú", "Â∞èÊ±†ÁæéÊ≥¢", "‰∫ï‰∏äÊ¢®Âêç"]},
                    categorizedSeries: {"Â∞ÅÂÖ•": ["1st Single„ÄåNobody's fault„ÄçÂ∞ÅÂÖ•", "2nd Single„ÄåBAN„ÄçÂ∞ÅÂÖ•", "3rd Single„ÄåÊµÅ„ÇåÂºæ„ÄçÂ∞ÅÂÖ•", "4th Single„Äå‰∫îÊúàÈõ®„Çà„ÄçÂ∞ÅÂÖ•", "1st Album„ÄåAs you know?„ÄçÂ∞ÅÂÖ•", "5th Single„ÄåÊ°úÊúà„ÄçÂ∞ÅÂÖ•", "6th Single„ÄåStart over!„ÄçÂ∞ÅÂÖ•", "7th Single„ÄåÊâøË™çÊ¨≤Ê±Ç„ÄçÂ∞ÅÂÖ•", "8th Single„Äå‰ΩïÊ≠≥„ÅÆÈ†É„Å´Êàª„Çä„Åü„ÅÑ„ÅÆ„Åã?„Äç Â∞ÅÂÖ•", "9th Single„ÄåËá™Ê•≠Ëá™Âæó„ÄçÂ∞ÅÂÖ•", "10th Single„ÄåI want tomorrow to come„ÄçÂ∞ÅÂÖ•", "11th Single„ÄåUDAGAWA GENERATION„ÄçÂ∞ÅÂÖ•", "2nd Album„ÄåAddiction„ÄçÂ∞ÅÂÖ•", "12th Single„ÄåMake or Break„ÄçÂ∞ÅÂÖ•", "13th Single„ÄåUnhappy birthdayÊßãÊñá„ÄçÂ∞ÅÂÖ•", "14th Single„ÄåThe growing up train„ÄçÂ∞ÅÂÖ•"], "MVË°£Ë£ù": ["„ÄåNobody's fault„ÄçMV„É≠„Ç±„Éº„Ç∑„Éß„É≥Ë°£Ë£Ö", "„Äå„Å™„ÅúÊÅã„Çí„Åó„Å¶Êù•„Å™„Åã„Å£„Åü„Çì„Å†„Çç„ÅÜ?„ÄçMV„É≠„Ç±„Éº„Ç∑„Éß„É≥Ë°£Ë£Ö", "„ÄåBuddies„ÄçMV„É≠„Ç±„Éº„Ç∑„Éß„É≥Ë°£Ë£Ö", "„ÄåBAN„ÄçMV„É≠„Ç±„Éº„Ç∑„Éß„É≥Ë°£Ë£Ö", "„ÄåÂÅ∂ÁÑ∂„ÅÆÁ≠î„Åà„ÄçMV„É≠„Ç±„Éº„Ç∑„Éß„É≥Ë°£Ë£Ö", "„ÄåÊÄù„Å£„Åü„Çà„Çä„ÇÇÂØÇ„Åó„Åè„ÅØ„Å™„ÅÑ„ÄçMV„É≠„Ç±„Éº„Ç∑„Éß„É≥Ë°£Ë£Ö", "„ÄåÊµÅ„ÇåÂºæ„ÄçMV„É≠„Ç±„Éº„Ç∑„Éß„É≥Ë°£Ë£Ö", "„ÄåDead end„ÄçMV„É≠„Ç±„Éº„Ç∑„Éß„É≥Ë°£Ë£Ö", "„ÄåÁÑ°Ë®Ä„ÅÆÂÆáÂÆô„ÄçMV„É≠„Ç±„Éº„Ç∑„Éß„É≥Ë°£Ë£Ö", "„ÄåDead end„ÄçMV„É≠„Ç±„Éº„Ç∑„Éß„É≥Ë°£Ë£Ö", "„ÄåÊµÅ„ÇåÂºæ„ÄçMVÈªíË°£Ë£Ö", "„Äå‰∫îÊúàÈõ®„Çà„ÄçMV„É≠„Ç±„Éº„Ç∑„Éß„É≥Ë°£Ë£Ö", "„Äå‰∫îÊúàÈõ®„Çà„ÄçMV„Éë„Éï„Ç©„Éº„Éû„É≥„ÇπË°£Ë£Ö", "„ÄåËªäÈñìË∑ùÈõ¢„ÄçMV„É≠„Ç±„Éº„Ç∑„Éß„É≥Ë°£Ë£Ö", "„ÄåÂÉï„ÅÆ„Ç∏„É¨„É≥„Éû„ÄçMV„É≠„Ç±„Éº„Ç∑„Éß„É≥Ë°£Ë£Ö", "„ÄåÊë©Êì¶‰øÇÊï∞„ÄçMVË°£Ë£Ö", "„ÄåÊ°úÊúà„ÄçMVË°£Ë£Ö", "„ÄåÊ°úÊúà„ÄçMVÈùíË°£Ë£Ö", "„ÄåCool„ÄçMVË°£Ë£Ö", "„ÄåÂ§è„ÅÆËøëÈÅì„Äç MVË°£Ë£Ö", "„ÄåÂ§è„ÅÆËøëÈÅì„Äç MVÂà∂Êúç", "„ÄåBAN„Äç MVË°£Ë£Ö", "„ÄåStart over!„ÄçMVË°£Ë£Ö", "„Äå„Éâ„É≠„Éº„É≥ÊóãÂõû‰∏≠„ÄçMVË°£Ë£Ö", "„ÄåÈùôÂØÇ„ÅÆÊö¥Âäõ„Äç MVË°£Ë£Ö", "„ÄåNobody's fault„ÄçMVË°£Ë£Ö", "„ÄåÊâøË™çÊ¨≤Ê±Ç„ÄçMVË°£Ë£Ö", "„Äå„Éû„É¢„É™„Éì„Éà„Äç MVË°£Ë£Ö", "„ÄåÈöôÈñìÈ¢®„Çà„ÄçMVË°£Ë£Ö", "„Äå‰ΩïÊ≠≥„ÅÆÈ†É„Å´Êàª„Çä„Åü„ÅÑ„ÅÆ„Åã?„ÄçMVË°£Ë£Ö", "„Äå‰ΩïÂ∫¶ LOVE SONG „ÅÆÊ≠åË©û„ÇíË™≠„ÅøËøî„Åó„Åü„Å†„Çç„ÅÜ„Äç MVË°£Ë£Ö", "„ÄåÊ≤π„ÇíÊ≥®„Åõ!„Äç MVË°£Ë£Ö", "„ÄåËá™Ê•≠Ëá™Âæó„ÄçMVË°£Ë£Ö", "„ÄåÊÑõ„ÅóÂêà„ÅÑ„Å™„Åï„ÅÑ„Äç MVË°£Ë£Ö", "„ÄåÂºï„Åç„Åì„ÇÇ„ÇãÊôÇÈñì„ÅØ„Å™„ÅÑ„Äç MVË°£Ë£Ö", "„ÄåI want tomorrow to come„ÄçMVË°£Ë£Ö", "„ÄåÊú¨Ë≥™ÁöÑ„Å™„Åì„Å®„Äç MVË°£Ë£Ö", "„ÄåÂÉï„ÅØÂÉï„ÇíÂ•Ω„Åç„Å´„Å™„Çå„Å™„ÅÑ„Äç MVË°£Ë£Ö", "„ÄåUDAGAWA GENERATION„ÄçMVË°£Ë£Ö", "„ÄåNothing Special„ÄçMVË°£Ë£Ö", "„ÄåNightmare ÁóáÂÄôÁæ§„ÄçMVË°£Ë£Ö", "„ÄåAddiction„Äç MVË°£Ë£Ö", "„ÄåMake or Break„Äç MVË°£Ë£Ö", "„ÄåÊ∏ØÂå∫„Éë„Çª„É™„Äç MVË°£Ë£Ö", "„ÄåÊ≠ª„Çì„Å†„Åµ„Çä„ÄçMVË°£Ë£Ö", "„ÄåUnhappy birthdayÊßãÊñá„ÄçMVË°£Ë£Ö", "„ÄåÊú®ÊûØ„Çâ„Åó„ÅØÊ≥£„Åã„Å™„ÅÑ„ÄçMVË°£Ë£Ö", "„ÄåAlter ego„ÄçMVË°£Ë£Ö", "„ÄåThe growing up train„ÄçMVË°£Ë£Ö"], "Â∞ÅÈù¢": ["ÊµÅ„ÇåÂºæ„Ç∏„É£„Ç±„ÉÉ„ÉàÂÜôÁúüË°£Ë£Ö", "„ÄåStart over!„Äç „Ç∏„É£„Ç±„ÉÉ„ÉàÂÜôÁúüË°£Ë£Ö", "„ÄåÊâøË™çÊ¨≤Ê±Ç„Äç„Ç∏„É£„Ç±„ÉÉ„ÉàÂÜôÁúüË°£Ë£Ö", "„Äå‰ΩïÊ≠≥„ÅÆÈ†É„Å´Êàª„Çä„Åü„ÅÑ„ÅÆ„Åã?„Äç„Ç∏„É£„Ç±„ÉÉ„ÉàÂÜôÁúüË°£Ë£Ö", "„ÄåËá™Ê•≠Ëá™Âæó„Äç„Ç∏„É£„Ç±„ÉÉ„ÉàÂÜôÁúüË°£Ë£Ö", "„ÄåI want tomorrow to come„Äç„Ç∏„É£„Ç±„ÉÉ„ÉàÂÜôÁúüË°£Ë£Ö", "„ÄåUDAGAWA GENERATION„Äç„Ç∏„É£„Ç±„ÉÉ„ÉàÂÜôÁúüË°£Ë£Ö", "„ÄåMake or Break„Äç„Ç∏„É£„Ç±„ÉÉ„ÉàÂÜôÁúüË°£Ë£Ö", "„ÄåUnhappy birthdayÊßãÊñá„Äç„Ç∏„É£„Ç±„ÉÉ„ÉàÂÜôÁúüË°£Ë£Ö", "„ÄåThe growing up train„Äç„Ç∏„É£„Ç±„ÉÉ„ÉàÂÜôÁúüË°£Ë£Ö"], "LIVEË°£Ë£ù": ["‰∏âÊúüÁîü„Éñ„ÉÉ„ÇØ„É¨„ÉÉ„ÉàË°£Ë£Ö", "„Äå3rd TOUR 2023„Äç„Ç™„Éº„Éó„Éã„É≥„Ç∞Ë°£Ë£Ö", "„Äå3rd TOUR 2023„ÄçÁôΩ„Çπ„Éº„ÉÑË°£Ë£Ö", "2023Âπ¥Â§è„Éï„Çß„ÇπË°£Ë£Ö", "„Äå3rd Single BACKS LIVE!!„ÄçË°£Ë£Ö", "„Äå3rd TOUR 2023„Äç„Éî„É≥„ÇØË°£Ë£Ö", "„Äå3rd YEAR ANNIVERSARY LIVE„Äç„É©„Ç§„ÉñË°£Ë£Ö", "„Äå7th Single BACKS LIVE!!„Äç„Ç™„Éº„Éó„Éã„É≥„Ç∞Ë°£Ë£Ö", "„ÄåÂ∞èÊûóÁî±‰æù ÂçíÊ•≠„Ç≥„É≥„Çµ„Éº„Éà„Äç„É©„Ç§„ÉñË°£Ë£Ö", "„ÄåÂ∞èÊûóÁî±‰æù ÂçíÊ•≠„Ç≥„É≥„Çµ„Éº„Éà„ÄçËµ§Ë°£Ë£Ö", "„Äå3rd TOUR 2023„Äç„É©„Ç§„ÉñË°£Ë£Ö", "2023Âπ¥ Âπ¥Êú´Ê≠åÂî±Ë°£Ë£Ö", "„Äå8th Single BACKS LIVE!!„Äç„É©„Ç§„ÉñË°£Ë£Ö", "„Äå4th ARENA TOUR 2024„Äç„É©„Ç§„ÉñË°£Ë£Ö", "„Äå3rd YEAR ANNIVERSARY LIVE„Äç„É©„Ç§„ÉñË°£Ë£Ö", "„Äå4th ARENA TOUR IN Êù±‰∫¨„Éâ„Éº„É†„Äç„Ç™„Éº„Éó„Éã„É≥„Ç∞Ë°£Ë£Ö", "„Äå9th Single BACKS LIVE!!„Äç„Ç™„Éº„Éó„Éã„É≥„Ç∞Ë°£Ë£Ö", "2023Âπ¥ Âπ¥Êú´Ë°£Ë£Ö", "2024Âπ¥Â§è„Éï„Çß„ÇπË°£Ë£Ö", "„Äå4th ARENA TOUR„Äç„Ç™„Éº„Éó„Éã„É≥„Ç∞Ë°£Ë£Ö", "„Äå4th YEAR ANNIVERSARY LIVE„Äç„É©„Ç§„ÉñË°£Ë£Ö", "„Äå4th ARENA TOUR„Äç„É©„Ç§„ÉñË°£Ë£Ö", "„Äå‰∏âÊúüÁîü„É©„Ç§„Éñ„Äç„Ç™„Éº„Éó„Éã„É≥„Ç∞Ë°£Ë£Ö", "„Äå4th ARENA TOUR IN Êù±‰∫¨„Éâ„Éº„É†„Äç„É©„Ç§„ÉñË°£Ë£Ö", "„Äå10th Single BACKS LIVE!!„Äç„É©„Ç§„ÉñË°£Ë£Ö", "„Äå5th TOUR 2025 ‚ÄúAddiction‚Äù„Äç„É©„Ç§„ÉñË°£Ë£Ö", "„Äå‰∏âÊúüÁîü„É©„Ç§„Éñ„ÄçË°£Ë£Ö", "„Äå12th Single BACKS LIVE!!„Äç„É©„Ç§„ÉñË°£Ë£Ö", "„Äå5th TOUR 2025 ‚ÄúAddiction‚Äù„ÄçÈªëË°£Ë£Ö", "„Äå12th Single BACKS LIVE!!„ÄçÈªëË°£Ë£Ö"], "ÂÖ∂‰ªñ": ["2023Âπ¥ ÂÜ¨ÁßÅÊúç„Ç≥„Éº„Éá", "„Çπ„Éº„ÉÑ„Ç≥„Éº„Éá", "„Ç´„É©„Éº„Ç≥„Éº„Éá", "„Çµ„Éû„Éº„ÉØ„É≥„Éî„Éº„Çπ", "„Éá„Éã„É†„Ç≥„Éº„Éá", "2023Âπ¥ „Éè„É≠„Ç¶„Ç£„É≥Ë°£Ë£Ö", "2023Âπ¥ „ÇØ„É™„Çπ„Éû„Çπ„Çµ„É≥„ÇøË°£Ë£Ö", "2023Âπ¥ Ë™≠Êõ∏„Ç≥„Éº„Éá", "2024Âπ¥ ÊåØË¢ñË°£Ë£Ö", "„Åä„ÅÜ„Å°„Ç≥„Éº„Éá", "„Ç∏„É£„É≥„Éó„Çπ„Éº„ÉÑ", "2024Âπ¥ Êò•ÁßÅÊúç„Ç≥„Éº„Éá", "„Ç´„É©„Éº„Éá„Éã„É†", "2024Âπ¥Êµ¥Ë°£", "È∫•„Çè„ÇâÂ∏ΩÂ≠ê„Ç≥„Éº„Éá", "T„Ç∑„É£„ÉÑ„Ç≥„Éº„Éá", "„ÉØ„Ç§„Ç∑„É£„ÉÑ„Ç≥„Éº„Éá", "2024Âπ¥ „Éè„É≠„Ç¶„Ç£„É≥Ë°£Ë£Ö", "„Ç´„É©„Éº„Éã„ÉÉ„Éà„Ç≥„Éº„Éá", "2024Âπ¥ „ÇØ„É™„Çπ„Éû„Çπ„Çµ„É≥„ÇøË°£Ë£Ö", "„Å©„ÅÜ„Å∂„Å§ÁùÄ„Åê„Çã„Åø", "„Éû„Éï„É©„Éº„Ç≥„Éº„Éá", "2025Âπ¥ÊåØË¢ñ", "„ÅÑ„Å¨„Åø„Åø„Ç≥„Éº„Éá", "„É¢„Éº„Éâ„Ç≥„Éº„Éá", "ÂÜ¨ÁßÅÊúç„Ç≥„Éº„Éá", "„Éç„ÇØ„Çø„Ç§„Ç≥„Éº„Éá", "„É¨„Ç∂„Éº„Ç∏„É£„Ç±„ÉÉ„Éà„Ç≥„Éº„Éá", "2025Âπ¥Êµ¥Ë°£", "„Éù„É≠„Ç∑„É£„ÉÑ„Ç≥„Éº„Éá", "„ÇØ„É©„Ç∑„ÉÉ„ÇØ„Ç≥„Éº„Éá", "„ÉÅ„Çß„ÉÉ„ÇØ„Ç≥„Éº„Éá", "„Éë„Ç§„É¨„Éº„ÉÑË°£Ë£Ö", "ÂÜ¨Êúç", "2025Âπ¥ „Çµ„É≥„ÇøË°£Ë£Ö", "„Çπ„Çø„Ç§„É™„É≥„Ç∞Âà∂Êúç", "2026Âπ¥ ÊåØË¢ñ", "„Ç∏„É£„Éº„Ç∏", "2026Âπ¥ „Éê„É¨„É≥„Çø„Ç§„É≥„Ç≥„Éº„Éá"], "ÁâπÊÆä": ["„Äê‰ºöÂ†¥‰∫àÁ¥ÑÁâπÂÖ∏„Äë Êù±‰∫¨„Éâ„Éº„É†ÈôêÂÆöÊàêÂì°ÁîüÂØ´Áúü", "Êù±‰∫¨„Éâ„Éº„É†ÂÆåË≥£Âæ°Á¶ÆÁ¥ÄÂøµ!! „É©„Ç§„ÉñÊúÉÂ†¥ÊíÆ„Çä„Åä„Çç„Åó„Éó„É¨„Éü„Ç¢„É†ÁîüÂØ´Áúü", "Á¶èË¢ã 2025 „Äå4th ARENA TOUR IN Êù±‰∫¨„Éâ„Éº„É†„Äç „Ç™„Éº„Éó„Éã„É≥„Ç∞Ë°£Ë£Ö", "Á¶èË¢ã 2026 MVË°£Ë£Ö"]},
                    newItem: { name: "", series: "", category: "" },
                    rawItems: [],
                    ownedIds: new Set(),
                    seriesImages: {},
                    expandedSeries: new Set(),
                    expandedSeriesMode: new Set(),
                    collapsedCategories: new Set(),
                    memberCollapsedCategories: new Set(),
                    zoomedImg: null,
                };
            },
            computed: {
                memberList() {
                    return [...new Set(this.rawItems.map((i) => i.name))];
                },
                itemsBySeriesNormalized() {
                    const grouped = {};

                    this.rawItems.forEach((item) => {
                        const cat = item.category || "ÂÖ∂‰ªñ";
                        if (!grouped[cat]) grouped[cat] = {};
                        if (!grouped[cat][item.series])
                            grouped[cat][item.series] = [];

                        let batch = grouped[cat][item.series].find(
                            (b) => b.batchId === item.batchId
                        );
                        if (!batch) {
                            batch = {
                                batchId: item.batchId,
                                seriesName: item.series,
                                memberName: item.name,
                                items: [],
                            };
                            grouped[cat][item.series].push(batch);
                        }
                        batch.items.push(item);
                    });

                    Object.values(grouped).forEach((seriesObj) => {
                        Object.values(seriesObj).forEach((batches) => {
                            const byMember = {};
                            batches.forEach((b) => {
                                if (!byMember[b.memberName])
                                    byMember[b.memberName] = [];
                                byMember[b.memberName].push(b);
                            });
                            Object.values(byMember).forEach((list) => {
                                const total = list.length;
                                list.sort((a, b) =>
                                    a.batchId.localeCompare(b.batchId)
                                );
                                list.forEach((b, idx) => {
                                    b.totalSets = total;
                                    b.groupIndex = idx + 1;
                                });
                            });
                        });
                    });

                    return grouped;
                },
                memberItemsGrouped() {
                    if (!this.currentMember) return [];
                    const groupedMap = {};

                    this.rawItems
                        .filter((i) => i.name === this.currentMember)
                        .forEach((item) => {
                            const cat = item.category || "ÂÖ∂‰ªñ";
                            if (!groupedMap[cat]) {
                                groupedMap[cat] = { category: cat, items: [] };
                            }
                            let batch = groupedMap[cat].items.find(
                                (b) => b.batchId === item.batchId
                            );
                            if (!batch) {
                                batch = {
                                    batchId: item.batchId,
                                    seriesName: item.series,
                                    items: [],
                                };
                                groupedMap[cat].items.push(batch);
                            }
                            batch.items.push(item);
                        });

                    Object.values(groupedMap).forEach((catBlock) => {
                        const bySeries = {};
                        catBlock.items.forEach((b) => {
                            if (!bySeries[b.seriesName])
                                bySeries[b.seriesName] = [];
                            bySeries[b.seriesName].push(b);
                        });
                        Object.values(bySeries).forEach((list) => {
                            const total = list.length;
                            list.sort((a, b) =>
                                a.batchId.localeCompare(b.batchId)
                            );
                            list.forEach((b, idx) => {
                                b.totalSets = total;
                                b.groupIndex = idx + 1;
                            });
                        });
                    });

                    return Object.values(groupedMap);
                },
            },
            async mounted() {
                try {
                    // ÂÖàÂòóË©¶Âæû IndexedDB ËÆÄÂèñ
                    let [r, o, s] = await Promise.all([
                        get("raw_items"),
                        get("owned_photos"),
                        get("series_images"),
                    ]);

                    // Â¶ÇÊûú IndexedDB Ê≤íÊúâ raw_itemsÔºåÊîπÂæû localStorage ÂÇô‰ªΩÈÇÑÂéü
                    if (!r) {
                        const backup = localStorage.getItem("sakura_txt");
                        if (backup) {
                            try {
                                const parsed = JSON.parse(backup);
                                if (parsed && Array.isArray(parsed.rawItems)) {
                                    r = parsed.rawItems;
                                }
                                if (parsed && Array.isArray(parsed.ownedIds)) {
                                    o = parsed.ownedIds;
                                }
                            } catch (e) {
                                console.error("Ëß£Êûê localStorage ÂÇô‰ªΩÂ§±ÊïóÔºö", e);
                            }
                        }
                    }

                    if (r && Array.isArray(r)) {
                        this.rawItems = r;
                    }
                    if (o && Array.isArray(o)) {
                        this.ownedIds = new Set(o);
                    }
                    if (s && typeof s === "object") {
                        this.seriesImages = s || {};
                    }
                } catch (e) {
                    console.error("ËºâÂÖ•Ë≥áÊñôÈåØË™§Ôºö", e);
                    // Â¶ÇÊûú IndexedDB Êï¥È´îÂá∫ÈåØÔºåÂÜçÂòóË©¶ localStorage ÂÇôÊè¥
                    try {
                        const backup = localStorage.getItem("sakura_txt");
                        if (backup) {
                            const parsed = JSON.parse(backup);
                            if (parsed && Array.isArray(parsed.rawItems)) {
                                this.rawItems = parsed.rawItems;
                            }
                            if (parsed && Array.isArray(parsed.ownedIds)) {
                                this.ownedIds = new Set(parsed.ownedIds);
                            }
                        }
                    } catch (e2) {
                        console.error("ÂÇôÊè¥ËºâÂÖ•ÔºàlocalStorageÔºâ‰πüÂ§±ÊïóÔºö", e2);
                    }
                }
            },
            methods: {
                async saveData() {
                    try {
                        // localStorage Á∞°ÊòìÂÇô‰ªΩ
                        localStorage.setItem(
                            "sakura_txt",
                            JSON.stringify({
                                rawItems: this.rawItems,
                                ownedIds: [...this.ownedIds],
                            })
                        );
                        // IndexedDB ÂÆåÊï¥Ë≥áÊñô
                        await Promise.all([
                            set("raw_items", this.rawItems),
                            set("owned_photos", [...this.ownedIds]),
                            set("series_images", this.seriesImages),
                        ]);
                    } catch (e) {
                        console.error("ÂÑ≤Â≠òË≥áÊñôÈåØË™§Ôºö", e);
                    }
                },
                onCategorySelect() {
                    if (this.selectedCategory !== "custom_cat") {
                        this.newItem.category = this.selectedCategory;
                    }
                    this.selectedPreset = "";
                },
                onSeriesSelect() {
                    if (this.selectedPreset !== "custom_series") {
                        this.newItem.series = this.selectedPreset;
                    }
                },
                getUniqueMemberCount(batches) {
                    return [...new Set(batches.map((b) => b.memberName))].length;
                },
                getMemberOwnedCount(name) {
                    return this.rawItems.filter(
                        (i) => i.name === name && this.ownedIds.has(i.id)
                    ).length;
                },
                getProgress(items) {
                    return {
                        count: items.filter((i) => this.ownedIds.has(i.id)).length,
                    };
                },
                getActiveMembersInGen(gen) {
                    return this.presetMembers[gen].filter((name) =>
                        this.memberList.includes(name)
                    );
                },
                toggleSeries(id) {
                    if (this.expandedSeries.has(id))
                        this.expandedSeries.delete(id);
                    else this.expandedSeries.add(id);
                },
                toggleSeriesMode(cat, sName) {
                    const key = cat + sName;
                    if (this.expandedSeriesMode.has(key))
                        this.expandedSeriesMode.delete(key);
                    else this.expandedSeriesMode.add(key);
                },
                toggleCategory(catName) {
                    if (this.collapsedCategories.has(catName))
                        this.collapsedCategories.delete(catName);
                    else this.collapsedCategories.add(catName);
                },
                toggleMemberCategory(catName) {
                    if (this.memberCollapsedCategories.has(catName))
                        this.memberCollapsedCategories.delete(catName);
                    else this.memberCollapsedCategories.add(catName);
                },
                async toggleItem(id) {
                    if (this.ownedIds.has(id)) this.ownedIds.delete(id);
                    else this.ownedIds.add(id);
                    await this.saveData();
                },
                async removeSeries(bId) {
                    if (confirm("Á¢∫ÂÆöÂà™Èô§Ôºü")) {
                        this.rawItems = this.rawItems.filter(
                            (i) => i.batchId !== bId
                        );
                        delete this.seriesImages[bId];
                        await this.saveData();
                    }
                },
                async removeImage(bId) {
                    if (confirm("Âà™Èô§ÂúñÁâáÔºü")) {
                        delete this.seriesImages[bId];
                        await this.saveData();
                    }
                },
                async handleSeriesImageUpload(event, bId) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = async () => {
                            const canvas =
                                document.createElement("canvas");
                            const MAX_WIDTH = 800;
                            canvas.width = MAX_WIDTH;
                            canvas.height =
                                (img.height * MAX_WIDTH) / img.width;
                            const ctx = canvas.getContext("2d");
                            ctx.drawImage(
                                img,
                                0,
                                0,
                                canvas.width,
                                canvas.height
                            );
                            this.seriesImages[bId] = canvas.toDataURL(
                                "image/jpeg",
                                0.5
                            );
                            await this.saveData();
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                },
                async addBatchItems() {
                    const names =
                        this.addMode === "member"
                            ? [this.newItem.name]
                            : this.batchMemberNames;

                    if (
                        !names.length ||
                        !this.newItem.series ||
                        !this.newItem.category
                    ) {
                        alert("Ë´ãÂÖàÈÅ∏ÊìáÊàêÂì° / ÂàÜÈ°û / Á≥ªÂàó");
                        return;
                    }

                    const tempCategory = this.newItem.category;
                    const tempSeries = this.newItem.series;
                    let lastBId = "";

                    names.forEach((name) => {
                        const bId =
                            "b-" +
                            Date.now() +
                            Math.random().toString(36).substr(2, 5);
                        lastBId = bId;

                        ["„É®„É™", "„ÉÅ„É•„Ç¶", "„Éí„Ç≠", "Â∫ß„Çä"].forEach(
                            (type) => {
                                this.rawItems.push({
                                    id: Math.random()
                                        .toString(36)
                                        .substr(2, 9),
                                    batchId: bId,
                                    name,
                                    series: tempSeries,
                                    category: tempCategory,
                                    type,
                                });
                            }
                        );
                    });

                    await this.saveData();
                    this.showInput = false;

                    const finalScroll = (id) => {
                        const el = document.getElementById(id);
                        if (el)
                            el.scrollIntoView({
                                behavior: "smooth",
                                block: "center",
                            });
                    };

                    if (this.addMode === "member") {
                        const keepName = this.newItem.name;
                        const keepGen = this.selectedGen;

                        this.currentMember = names[0];
                        nextTick(() => {
                            this.expandedSeries.add(lastBId);
                            setTimeout(
                                () =>
                                    finalScroll(
                                        "batch-target-" + lastBId
                                    ),
                                400
                            );
                        });

                        this.newItem.name = keepName;
                        this.selectedGen = keepGen;
                        this.newItem.series = "";
                        this.newItem.category = "";
                        this.selectedCategory = "";
                        this.selectedPreset = "";
                    } else {
                        this.viewMode = "series";
                        nextTick(() => {
                            this.expandedSeriesMode.add(
                                tempCategory + tempSeries
                            );
                            setTimeout(
                                () =>
                                    finalScroll(
                                        "series-target-" + tempSeries
                                    ),
                                400
                            );
                        });
                        this.batchMemberNames = [];
                    }
                },
                async exportData() {
                    const data = {
                        rawItems: this.rawItems,
                        ownedIds: [...this.ownedIds],
                        seriesImages: this.seriesImages,
                    };
                    const blob = new Blob([JSON.stringify(data)], {
                        type: "text/plain",
                    });
                    const a = document.createElement("a");
                    a.href = URL.createObjectURL(blob);
                    a.download = `sakura_backup.txt`;
                    a.click();
                },
                async importDataFromFile(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    try {
                        const text = await file.text();
                        const json = JSON.parse(text);

                        if (!json || typeof json !== "object") {
                            throw new Error("JSON Ê†ºÂºèÈåØË™§");
                        }

                        const { rawItems, ownedIds, seriesImages } = json;

                        if (!Array.isArray(rawItems)) {
                            throw new Error("rawItems Ê†ºÂºèÈåØË™§");
                        }

                        this.rawItems = rawItems;
                        this.ownedIds = new Set(
                            Array.isArray(ownedIds) ? ownedIds : []
                        );
                        this.seriesImages =
                            seriesImages &&
                            typeof seriesImages === "object"
                                ? seriesImages
                                : {};

                        await this.saveData();
                        alert("ÈÇÑÂéüÂÆåÊàêÔºÅ");
                        event.target.value = "";
                    } catch (e) {
                        console.error("ÈÇÑÂéüÂ§±ÊïóÔºö", e);
                        alert(
                            "ÈÇÑÂéüÂ§±ÊïóÔºöÊ™îÊ°àÊ†ºÂºèÂèØËÉΩÊúâÂïèÈ°åÔºåÊàñ‰∏çÊòØÊ≠£Á¢∫ÁöÑÂÇô‰ªΩÊ™î„ÄÇ"
                        );
                        event.target.value = "";
                    }
                },
                async clearAll() {
                    if (confirm("Ê∏ÖÁ©∫ÊâÄÊúâË≥áÊñôÔºü")) {
                        try {
                            await clear();
                        } catch (e) {
                            console.error("Ê∏ÖÁ©∫ÂÑ≤Â≠òÂ§±ÊïóÔºö", e);
                        }
                        localStorage.removeItem("sakura_txt");
                        location.reload();
                    }
                },
            },
        }).mount("#app");
    })();
</script>
</body>
</html>
