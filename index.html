<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
  />
  <title>ğŸŒ¸ æ«»å‚46 Collection</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans TC",
        sans-serif !important;
      text-transform: none !important;
      box-sizing: border-box;
    }
    [v-cloak] { display: none; }

    .photo-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 5px;
      width: 100%;
    }
    .series-photo-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 4px;
      width: 100%;
      max-width: 170px;
    }
    .item-slot {
      aspect-ratio: 2 / 1;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      font-size: 10px;
      font-weight: 800;
      transition: all 0.2s;
    }
    .section-header {
      font-size: 12px;
      font-weight: 900;
      color: #64748b;
      margin: 22px 0 8px 4px;
      border-left: 3px solid #f472b6;
      padding-left: 8px;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(4px);
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .group-tag {
      font-size: 8px;
      background: #fee2e2;
      color: #ef4444;
      padding: 1px 4px;
      border-radius: 4px;
      margin-left: 5px;
      font-weight: bold;
    }
    .tab-btn {
      font-size: 11px;
      font-weight: 900;
      padding: 6px 16px;
      border-radius: 99px;
    }
    .tab-active {
      background: #f472b6;
      color: white;
    }
  </style>
</head>
<body class="bg-slate-50 min-h-screen">
  <div id="app" v-cloak>
    <!-- NAV -->
    <nav
      class="bg-white shadow-sm p-4 sticky top-0 z-30 flex justify-between items-center border-b"
    >
      <h1
        class="text-xl font-black text-gray-800 cursor-pointer"
        @click="
          currentMember = null;
          viewMode = 'member';
        "
      >
        ğŸŒ¸ æ«»å‚46
      </h1>
      <button
        @click="showInput = true"
        class="text-[10px] bg-slate-800 text-white px-4 py-2 rounded-full font-bold shadow-lg"
      >
        ç®¡ç†é¢æ¿
      </button>
    </nav>

    <!-- ç®¡ç†é¢æ¿ -->
    <div v-if="showInput" class="modal-overlay" @click.self="showInput = false">
      <div
        class="bg-white w-full max-w-sm p-6 rounded-3xl shadow-2xl border-t-4 border-pink-400 relative overflow-y-auto max-h-[90vh]"
      >
        <button
          @click="showInput = false"
          class="absolute top-4 right-4 text-gray-300 font-bold"
        >
          âœ•
        </button>
        <h3 class="text-base font-black text-gray-800 mb-4">è³‡æ–™ç®¡ç†</h3>

        <div class="flex bg-slate-100 p-1 rounded-xl mb-4 text-[10px] font-bold">
          <button
            @click="addMode = 'member'"
            class="flex-1 py-2 rounded-lg"
            :class="addMode === 'member' ? 'bg-white shadow text-pink-500' : ''"
          >
            æŒ‰æˆå“¡
          </button>
          <button
            @click="addMode = 'series'"
            class="flex-1 py-2 rounded-lg"
            :class="addMode === 'series' ? 'bg-white shadow text-pink-500' : ''"
          >
            æŒ‰ç³»åˆ—
          </button>
        </div>

        <div class="space-y-3 text-xs text-gray-700">
          <!-- æŒ‰æˆå“¡æ–°å¢ -->
          <template v-if="addMode === 'member'">
            <select
              v-model="selectedGen"
              class="w-full border p-2.5 rounded-xl bg-white font-bold"
            >
              <option value="">-- æœŸåˆ¥ --</option>
              <option v-for="(ms, g) in presetMembers" :key="g" :value="g">
                {{ g }}
              </option>
            </select>

            <select
              v-if="selectedGen"
              v-model="newItem.name"
              class="w-full border p-2.5 rounded-xl bg-white font-bold"
            >
              <option
                v-for="n in presetMembers[selectedGen]"
                :key="n"
                :value="n"
              >
                {{ n }}
              </option>
            </select>

            <select
              v-model="selectedCategory"
              @change="onCategorySelect"
              class="w-full border p-2.5 rounded-xl bg-white"
            >
              <option value="">-- åˆ†é¡ --</option>
              <option
                v-for="(list, cat) in categorizedSeries"
                :key="cat"
                :value="cat"
              >
                {{ cat }}
              </option>
              <option value="custom_cat">ï¼‹ è‡ªå®šç¾©</option>
            </select>

            <select
              v-if="selectedCategory"
              v-model="selectedPreset"
              @change="onSeriesSelect"
              class="w-full border p-2.5 rounded-xl bg-white"
            >
              <option value="">-- ç³»åˆ— --</option>
              <option
                v-for="s in categorizedSeries[selectedCategory] || []"
                :key="s"
                :value="s"
              >
                {{ s }}
              </option>
              <option value="custom_series">ï¼‹ æ‰‹å‹•è¼¸å…¥</option>
            </select>
          </template>

          <!-- æŒ‰ç³»åˆ—æ–°å¢ï¼ˆå¤šæˆå“¡ï¼‰ -->
          <template v-else>
            <select
              v-model="selectedCategory"
              @change="onCategorySelect"
              class="w-full border p-2.5 rounded-xl bg-white"
            >
              <option value="">-- åˆ†é¡ --</option>
              <option
                v-for="(list, cat) in categorizedSeries"
                :key="cat"
                :value="cat"
              >
                {{ cat }}
              </option>
            </select>

            <select
              v-if="selectedCategory"
              v-model="selectedPreset"
              @change="onSeriesSelect"
              class="w-full border p-2.5 rounded-xl bg-white"
            >
              <option value="">-- ç³»åˆ— --</option>
              <option
                v-for="s in categorizedSeries[selectedCategory] || []"
                :key="s"
                :value="s"
              >
                {{ s }}
              </option>
            </select>

            <select
              v-if="selectedPreset"
              v-model="selectedGen"
              class="w-full border p-2.5 rounded-xl bg-white font-bold"
            >
              <option value="">-- æœŸåˆ¥ --</option>
              <option
                v-for="(ms, g) in presetMembers"
                :key="g"
                :value="g"
              >
                {{ g }}
              </option>
            </select>

            <div
              v-if="selectedGen && selectedPreset"
              class="border rounded-xl p-3 bg-slate-50 max-h-40 overflow-y-auto"
            >
              <label
                v-for="n in presetMembers[selectedGen]"
                :key="n"
                class="flex items-center mb-1"
              >
                <input
                  type="checkbox"
                  :value="n"
                  v-model="batchMemberNames"
                  class="mr-2 accent-pink-500"
                />
                <span>{{ n }}</span>
              </label>
            </div>
          </template>

          <!-- è‡ªå®šç¾©åˆ†é¡ / ç³»åˆ— -->
          <input
            v-if="selectedCategory === 'custom_cat'"
            v-model="newItem.category"
            type="text"
            placeholder="æ‰‹å‹•åˆ†é¡"
            class="w-full border p-2.5 rounded-xl"
          />
          <input
            v-if="
              selectedPreset === 'custom_series' ||
              selectedCategory === 'custom_cat'
            "
            v-model="newItem.series"
            type="text"
            placeholder="æ‰‹å‹•ç³»åˆ—"
            class="w-full border p-2.5 rounded-xl"
          />

          <button
            @click="addBatchItems"
            class="w-full bg-pink-500 text-white p-3 rounded-xl font-bold shadow-lg"
          >
            ç¢ºèªæ–°å¢
          </button>
        </div>

        <!-- åŒ¯å‡º / åŒ¯å…¥ / æ¸…ç©º -->
        <div class="flex justify-center gap-4 mt-8 border-t pt-4 text-xs items-center">
          <button @click="exportData" class="text-blue-500 font-bold">
            åŒ¯å‡ºå‚™ä»½
          </button>

          <button
            @click="$refs.importFile.click()"
            class="text-emerald-500 font-bold"
          >
            åŒ¯å…¥é‚„åŸ
          </button>

          <button @click="clearAll" class="text-red-300 font-bold">
            æ¸…ç©º
          </button>

          <input
            type="file"
            ref="importFile"
            class="hidden"
            accept=".txt,.json"
            @change="importData"
          />
        </div>
      </div>
    </div>

    <!-- å…§å®¹å€ -->
    <main class="max-w-xl mx-auto p-3">
      <!-- Tabs -->
      <div
        v-if="!currentMember"
        class="flex justify-center items-center gap-4 my-4"
      >
        <button
          @click="viewMode = 'member'"
          class="tab-btn"
          :class="viewMode === 'member' ? 'tab-active' : 'text-slate-400'"
        >
          æˆå“¡æ¨¡å¼
        </button>
        <button
          @click="viewMode = 'series'"
          class="tab-btn"
          :class="viewMode === 'series' ? 'tab-active' : 'text-slate-400'"
        >
          ç³»åˆ—æ¨¡å¼
        </button>
      </div>

      <!-- æˆå“¡æ¨¡å¼ï¼šæˆå“¡åˆ—è¡¨ -->
      <div v-if="!currentMember && viewMode === 'member'">
        <div v-for="(ms, g) in presetMembers" :key="g">
          <div v-if="getActiveMembersInGen(g).length > 0">
            <h2 class="section-header" @click="toggleMemberListCat(g)">
              <span>{{ g }}</span>
              <span class="text-[10px] text-slate-400">
                {{ getGenActiveCount(g) === 1 ? '1 Member' : getGenActiveCount(g) + ' Members' }}
                <span class="ml-1">
                  {{ collapsedMemberListCats.has(g) ? 'â–¼' : 'â–²' }}
                </span>
              </span>
            </h2>

            <div
              v-if="!collapsedMemberListCats.has(g)"
              class="grid grid-cols-2 gap-3"
            >
              <div
                v-for="name in getActiveMembersInGen(g)"
                :key="name"
                @click="currentMember = name"
                class="bg-white p-5 rounded-2xl shadow-sm text-center cursor-pointer"
              >
                <div class="font-black text-gray-700">{{ name }}</div>
                <div class="text-[8px] font-bold text-pink-400">
                  {{ getMemberOwnedCount(name) }} Collected
                </div>
              </div>
            </div>
          </div>
        </div>

        <div
          v-if="memberList.length === 0"
          class="text-center py-24 text-slate-300 font-bold italic"
        >
          ç›®å‰å°šç„¡æ”¶è—è³‡æ–™
        </div>
      </div>

      <!-- ç³»åˆ—æ¨¡å¼ -->
      <div v-if="!currentMember && viewMode === 'series'">
<!-- ç³»åˆ—æ¨¡å¼ï¼šç¯©é¸åˆ—é–‹é—œ -->
<div class="flex justify-end mb-2 px-1">
  <button
    @click="showSeriesFilter = !showSeriesFilter"
    class="text-[10px] font-bold text-slate-500"
  >
    {{ showSeriesFilter ? 'æ”¶èµ·ç¯©é¸ â–²' : 'å±•é–‹ç¯©é¸ â–¼' }}
  </button>
</div>

<!-- ç³»åˆ—æ¨¡å¼ï¼šæˆå“¡ç¯©é¸ -->
<div v-if="showSeriesFilter"
     class="flex flex-wrap gap-2 mb-3 px-1">
  <button
    v-for="(order, name) in memberOrderMap"
    :key="name"
    @click="
      seriesMemberFilter.has(name)
        ? seriesMemberFilter.delete(name)
        : seriesMemberFilter.add(name)
    "
    class="text-[10px] px-3 py-1 rounded-full border font-bold"
    :class="
      seriesMemberFilter.has(name)
        ? 'bg-pink-500 text-white border-pink-500'
        : 'bg-white text-slate-400 border-slate-200'
    "
  >
    {{ name }}
  </button>

  <button
    v-if="seriesMemberFilter.size"
    @click="seriesMemberFilter.clear()"
    class="text-[10px] px-3 py-1 rounded-full bg-slate-200 text-slate-600 font-bold"
  >
    æ¸…é™¤
  </button>
</div>

        <div v-for="(seriesObj, catName) in itemsBySeriesSorted" :key="catName">
          <h2 class="section-header" @click="toggleCategorySeries(catName)">
            <span>{{ catName }}</span>
            <span class="text-[10px] text-slate-400">
              {{ Object.keys(seriesObj).length }} ç³»åˆ—
              <span class="ml-1">
                {{ collapsedSeriesCats.has(catName) ? 'â–¼' : 'â–²' }}
              </span>
            </span>
          </h2>

          <div v-if="!collapsedSeriesCats.has(catName)">
            <div
              v-for="(batches, seriesName) in seriesObj"
              :key="seriesName"
              :id="'series-target-' + seriesName"
              class="mb-2 bg-white rounded-2xl shadow-sm border overflow-hidden"
            >
              <div
                @click="toggleSeriesMode(catName, seriesName)"
                class="px-4 py-3 flex justify-between items-center cursor-pointer"
              >
                <div class="flex items-center min-w-0">
                  <span
                    class="font-black text-gray-600 text-[10px] truncate max-w-full"
                    :title="seriesName"
                  >
                    {{ seriesName }}
                  </span>
                </div>
                <div class="text-[9px] font-bold text-pink-400 shrink-0">
                  {{ getUniqueMemberCount(batches) === 1
      ? '1 Member'
      : getUniqueMemberCount(batches) + ' Members'
 }}
                </div>
              </div>

              <div
                v-if="expandedSeriesMode.has(catName + seriesName)"
                class="p-3 border-t bg-slate-50/50 space-y-3"
              >
                <div
                  v-for="b in batches"
                  :key="b.batchId"
                  class="flex items-center gap-4 py-2 border-b border-gray-50 last:border-0"
                >
                  <div
                    @click="currentMember = b.memberName"
                    class="text-[11px] font-bold cursor-pointer flex items-center min-w-[90px] max-w-[90px]"
                  >
                    <span class="truncate">{{ b.memberName }}</span>
                    <span
                      v-if="b.totalSets > 1"
                      class="group-tag ml-1 shrink-0"
                    >
                      SET {{ b.groupIndex }}
                    </span>
                  </div>

                  <div class="series-photo-grid w-[170px] shrink-0">
                    <div
                      v-for="item in b.items"
                      :key="item.id"
                      @click="toggleItem(item.id)"
                      class="item-slot border cursor-pointer"
                      :class="
                        ownedIds.has(item.id)
                          ? 'bg-pink-500 border-pink-500 text-white'
                          : 'bg-white text-gray-200'
                      "
                    >
                      {{ item.type }}
                    </div>
                  </div>

                  <div
                    class="text-[9px] font-black text-right w-[40px] shrink-0"
                    :class="
                      getProgress(b.items).count === 4
                        ? 'text-green-500'
                        : 'text-pink-400'
                    "
                  >
                    {{
                      getProgress(b.items).count === 4
                        ? 'Complete'
                        : getProgress(b.items).count + '/4'
                    }}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- æˆå“¡è©³ç´°é  -->
      <div v-if="currentMember">
        <div class="flex items-center justify-between mb-6 px-1">
          <div class="flex items-center gap-2">
            <button
              @click="currentMember = null"
              class="text-gray-300 font-bold text-2xl px-2"
            >
              â€¹
            </button>
            <div class="relative">
              <select
                v-model="currentMember"
                class="appearance-none bg-transparent font-black text-2xl outline-none pr-8 cursor-pointer"
              >
                <optgroup
                  v-for="(names, gen) in presetMembers"
                  :key="gen"
                  :label="gen"
                >
                  <option
                    v-for="name in getActiveMembersInGen(gen)"
                    :key="name"
                    :value="name"
                  >
                    {{ name }}
                  </option>
                </optgroup>
              </select>
              <div
                class="pointer-events-none absolute inset-y-0 right-0 flex items-center text-pink-500"
              >
                â–¼
              </div>
            </div>
          </div>
        </div>

        <div
          v-for="catBlock in memberItemsGrouped"
          :key="catBlock.category"
          class="mb-8"
        >
          <h2
            class="section-header"
            @click="toggleCategoryMember(catBlock.category)"
          >
            <span>{{ catBlock.category }}</span>
            <span class="text-[10px] text-slate-400">
              {{ catBlock.items.length }} ç³»åˆ—
              <span class="ml-1">
                {{ collapsedMemberCats.has(catBlock.category) ? 'â–¼' : 'â–²' }}
              </span>
            </span>
          </h2>

          <div v-if="!collapsedMemberCats.has(catBlock.category)">
            <div
              v-for="batch in catBlock.items"
              :key="batch.batchId"
              :id="'batch-target-' + batch.batchId"
              class="mb-2.5 bg-white rounded-xl shadow-sm border overflow-hidden"
            >
              <div
                class="p-4 flex justify-between items-center cursor-pointer"
                @click="toggleSeries(batch.batchId)"
              >
                <div class="flex items-center min-w-0">
                  <span
                    class="font-bold text-xs text-gray-700 truncate max-w-full"
                    :title="batch.seriesName"
                  >
                    {{ batch.seriesName }}
                  </span>
                  <span
                    v-if="batch.totalSets > 1"
                    class="group-tag ml-1 shrink-0"
                  >
                    SET {{ batch.groupIndex }}
                  </span>
                </div>

                <div class="flex items-center gap-2">
                  <span
                    class="text-[9px] font-black"
                    :class="
                      getProgress(batch.items).count === 4
                        ? 'text-green-500'
                        : 'text-pink-400'
                    "
                    @click.stop
                  >
                    {{
                      getProgress(batch.items).count === 4
                        ? 'Complete'
                        : getProgress(batch.items).count + '/4'
                    }}
                  </span>
                  <button
                    @click.stop="removeSeries(batch.batchId)"
                    class="text-red-200"
                  >
                    âœ•
                  </button>
                </div>
              </div>

              <div
                v-if="expandedSeries.has(batch.batchId)"
                class="p-4 border-t bg-slate-50/20"
              >
                <div
                  class="mb-4 relative aspect-video bg-slate-100 rounded-xl overflow-hidden group"
                >
                  <template v-if="seriesImages[batch.batchId]">
                    <img
                      :src="seriesImages[batch.batchId]"
                      @click="zoomedImg = seriesImages[batch.batchId]"
                      class="w-full h-full object-contain"
                    />
                    <button
                      @click.stop="removeImage(batch.batchId)"
                      class="absolute top-2 right-2 bg-red-500/80 text-white w-6 h-6 rounded-full flex items-center justify-center text-[10px]"
                    >
                      âœ•
                    </button>
                  </template>
                  <label
                    v-else
                    class="w-full h-full flex items-center justify-center cursor-pointer text-[10px] text-slate-400"
                  >
                    + ä¸Šå‚³åœ–ç‰‡
                    <input
                      type="file"
                      class="hidden"
                      @change="(e) => handleSeriesImageUpload(e, batch.batchId)"
                      accept="image/*"
                    />
                  </label>
                </div>

                <div class="photo-grid">
                  <div
                    v-for="item in batch.items"
                    :key="item.id"
                    @click="toggleItem(item.id)"
                    class="item-slot border-2 cursor-pointer"
                    :class="
                      ownedIds.has(item.id)
                        ? 'border-pink-500 bg-pink-500 text-white'
                        : 'border-gray-100 bg-white text-gray-300'
                    "
                  >
                    {{ item.type }}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- å›é ‚ç«¯æŒ‰éˆ• -->
    <button
      v-if="showScrollTop"
      @click="scrollToTop"
      class="fixed bottom-4 right-4 bg-pink-500 text-white text-[10px] font-bold px-3 py-2 rounded-full shadow-lg active:scale-95 transition-transform z-[150]"
    >
      â¬† å›é ‚ç«¯
    </button>

    <!-- åœ–ç‰‡æ”¾å¤§ -->
    <div
      v-if="zoomedImg"
      @click="zoomedImg = null"
      class="fixed inset-0 bg-black/95 z-[200] flex items-center justify-center p-2"
    >
      <img :src="zoomedImg" class="max-w-full max-h-full object-contain" />
    </div>
  </div>

  <script>
    const { createApp } = Vue;

    function createStorage() {
      if (!('indexedDB' in window)) {
        console.warn('æ­¤è£ç½®ä¸æ”¯æ´ IndexedDBï¼Œå°‡ä½¿ç”¨ localStorageã€‚');
        const PREFIX = 'sakura_kv_';
        return {
          async get(key) {
            try {
              const raw = localStorage.getItem(PREFIX + key);
              return raw ? JSON.parse(raw) : null;
            } catch (e) {
              console.error('localStorage get éŒ¯èª¤ï¼š', e);
              return null;
            }
          },
          async set(key, value) {
            try {
              localStorage.setItem(PREFIX + key, JSON.stringify(value));
            } catch (e) {
              console.error('localStorage set éŒ¯èª¤ï¼š', e);
            }
          },
          async clear() {
            try {
              Object.keys(localStorage).forEach((k) => {
                if (k.startsWith(PREFIX)) localStorage.removeItem(k);
              });
            } catch (e) {
              console.error('localStorage clear éŒ¯èª¤ï¼š', e);
            }
          },
        };
      }

      const DB_NAME = 'sakura_collection_db';
      const STORE_NAME = 'kv';

      function openDB() {
        return new Promise((resolve, reject) => {
          const req = indexedDB.open(DB_NAME, 1);
          req.onupgradeneeded = function (event) {
            const db = event.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
              db.createObjectStore(STORE_NAME);
            }
          };
          req.onsuccess = function () {
            resolve(req.result);
          };
          req.onerror = function () {
            reject(req.error);
          };
        });
      }

      console.log('ä½¿ç”¨ IndexedDB å„²å­˜è³‡æ–™ã€‚');

      return {
        async get(key) {
          const db = await openDB();
          return new Promise((resolve, reject) => {
            const tx = db.transaction(STORE_NAME, 'readonly');
            const store = tx.objectStore(STORE_NAME);
            const req = store.get(key);
            req.onsuccess = function () {
              const raw = req.result;
              if (typeof raw === 'string') {
                try {
                  resolve(JSON.parse(raw));
                } catch (e) {
                  console.error('è§£æ IndexedDB JSON å¤±æ•—ï¼š', e);
                  resolve(null);
                }
              } else {
                resolve(raw != null ? raw : null);
              }
            };
            req.onerror = function () {
              reject(req.error);
            };
          });
        },
        async set(key, value) {
          const db = await openDB();
          var payload;
          try {
            payload = JSON.stringify(value);
          } catch (e) {
            console.error('æº–å‚™å¯«å…¥ IndexedDB æ™‚ JSON åºåˆ—åŒ–å¤±æ•—ï¼š', e);
            throw e;
          }
          return new Promise((resolve, reject) => {
            const tx = db.transaction(STORE_NAME, 'readwrite');
            const store = tx.objectStore(STORE_NAME);
            const req = store.put(payload, key);
            req.onsuccess = function () {
              resolve();
            };
            req.onerror = function () {
              reject(req.error);
            };
          });
        },
        async clear() {
          const db = await openDB();
          return new Promise((resolve, reject) => {
            const tx = db.transaction(STORE_NAME, 'readwrite');
            const store = tx.objectStore(STORE_NAME);
            const req = store.clear();
            req.onsuccess = function () {
              resolve();
            };
            req.onerror = function () {
              reject(req.error);
            };
          });
        },
      };
    }

    const storage = createStorage();
    const get = storage.get;
    const set = storage.set;
    const clear = storage.clear;

    createApp({
      data() {
        return {
          viewMode: 'member',
          addMode: 'member',
          showInput: false,
          currentMember: null,
          selectedGen: '',
          selectedCategory: '',
          selectedPreset: '',
          batchMemberNames: [],
          scrollY: 0,
          showScrollTop: false,

          presetMembers: {"äºŒæœŸç”Ÿ": ["é è—¤å…‰è‰", "å¤§åœ’ç²", "å¤§æ²¼æ™¶ä¿", "å¹¸é˜ªèŒ‰é‡Œä¹ƒ", "æ­¦å…ƒå”¯è¡£", "ç”°æ‘ä¿ä¹ƒ", "è—¤å‰å¤éˆ´", "å¢—æœ¬ç¶ºè‰¯", "æ¾ç”°é‡Œå¥ˆ", "æ£®ç”°ã²ã‹ã‚‹", "å®ˆå±‹éº—å¥ˆ", "å±±ï¨‘å¤©"], "ä¸‰æœŸç”Ÿ": ["çŸ³æ£®ç’ƒèŠ±", "é è—¤ç†å­", "å°ç”°å€‰éº—å¥ˆ", "å°å³¶å‡ªç´—", "è°·å£æ„›å­£", "ä¸­å¶‹å„ªæœˆ", "çš„é‡ç¾é’", "å‘äº•ç´”è‘‰", "æ‘äº•å„ª", "æ‘å±±ç¾ç¾½", "å±±ä¸‹ç³æœˆ"], "å››æœŸç”Ÿ": ["æµ…äº•æ‹ä¹ƒæœª", "ç¨²ç†Šã²ãª", "å‹åˆæ˜¥", "ä½è—¤æ„›æ¡œ", "ä¸­å·æ™ºå°‹", "æ¾æœ¬å’Œå­", "ç›®é»’é™½è‰²", "å±±å·å®‡è¡£", "å±±ç”°æ¡ƒå®Ÿ"], "ç•¢æ¥­ç”Ÿ": ["æ¾å¹³ç’ƒå­", "å®ˆå±‹èŒœ", "æ¸¡é‚‰æ¢¨åŠ ", "æ¸¡é‚‰ç†ä½", "åŸç”°è‘µ", "å°¾é–¢æ¢¨é¦™", "è…äº•å‹é¦™", "é–¢æœ‰ç¾å­", "åœŸç”Ÿç‘ç©‚", "å°æ—ç”±ä¾", "é½‹è—¤å†¬å„ªèŠ±", "ä¸Šæ‘è‰èœ", "å°æ± ç¾æ³¢", "äº•ä¸Šæ¢¨å"]},
                    categorizedSeries: {"å°å…¥": ["1st Singleã€ŒNobody's faultã€å°å…¥", "2nd Singleã€ŒBANã€å°å…¥", "3rd Singleã€Œæµã‚Œå¼¾ã€å°å…¥", "4th Singleã€Œäº”æœˆé›¨ã‚ˆã€å°å…¥", "1st Albumã€ŒAs you know?ã€å°å…¥", "5th Singleã€Œæ¡œæœˆã€å°å…¥", "6th Singleã€ŒStart over!ã€å°å…¥", "7th Singleã€Œæ‰¿èªæ¬²æ±‚ã€å°å…¥", "8th Singleã€Œä½•æ­³ã®é ƒã«æˆ»ã‚ŠãŸã„ã®ã‹?ã€ å°å…¥", "9th Singleã€Œè‡ªæ¥­è‡ªå¾—ã€å°å…¥", "10th Singleã€ŒI want tomorrow to comeã€å°å…¥", "11th Singleã€ŒUDAGAWA GENERATIONã€å°å…¥", "2nd Albumã€ŒAddictionã€å°å…¥", "12th Singleã€ŒMake or Breakã€å°å…¥", "13th Singleã€ŒUnhappy birthdayæ§‹æ–‡ã€å°å…¥", "14th Singleã€ŒThe growing up trainã€å°å…¥"], "MVè¡£è£": ["ã€ŒNobody's faultã€MVãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¡£è£…", "ã€Œãªãœæ‹ã‚’ã—ã¦æ¥ãªã‹ã£ãŸã‚“ã ã‚ã†?ã€MVãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¡£è£…", "ã€ŒBuddiesã€MVãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¡£è£…", "ã€ŒBANã€MVãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¡£è£…", "ã€Œå¶ç„¶ã®ç­”ãˆã€MVãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¡£è£…", "ã€Œæ€ã£ãŸã‚ˆã‚Šã‚‚å¯‚ã—ãã¯ãªã„ã€MVãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¡£è£…", "ã€Œæµã‚Œå¼¾ã€MVãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¡£è£…", "ã€ŒDead endã€MVãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¡£è£…", "ã€Œç„¡è¨€ã®å®‡å®™ã€MVãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¡£è£…", "ã€ŒDead endã€MVãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¡£è£…", "ã€Œæµã‚Œå¼¾ã€MVé»’è¡£è£…", "ã€Œäº”æœˆé›¨ã‚ˆã€MVãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¡£è£…", "ã€Œäº”æœˆé›¨ã‚ˆã€MVãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¡£è£…", "ã€Œè»Šé–“è·é›¢ã€MVãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¡£è£…", "ã€Œåƒ•ã®ã‚¸ãƒ¬ãƒ³ãƒã€MVãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¡£è£…", "ã€Œæ‘©æ“¦ä¿‚æ•°ã€MVè¡£è£…", "ã€Œæ¡œæœˆã€MVè¡£è£…", "ã€Œæ¡œæœˆã€MVé’è¡£è£…", "ã€ŒCoolã€MVè¡£è£…", "ã€Œå¤ã®è¿‘é“ã€ MVè¡£è£…", "ã€Œå¤ã®è¿‘é“ã€ MVåˆ¶æœ", "ã€ŒBANã€ MVè¡£è£…", "ã€ŒStart over!ã€MVè¡£è£…", "ã€Œãƒ‰ãƒ­ãƒ¼ãƒ³æ—‹å›ä¸­ã€MVè¡£è£…", "ã€Œé™å¯‚ã®æš´åŠ›ã€ MVè¡£è£…", "ã€ŒNobody's faultã€MVè¡£è£…", "ã€Œæ‰¿èªæ¬²æ±‚ã€MVè¡£è£…", "ã€Œãƒãƒ¢ãƒªãƒ“ãƒˆã€ MVè¡£è£…", "ã€Œéš™é–“é¢¨ã‚ˆã€MVè¡£è£…", "ã€Œä½•æ­³ã®é ƒã«æˆ»ã‚ŠãŸã„ã®ã‹?ã€MVè¡£è£…", "ã€Œä½•åº¦ LOVE SONG ã®æ­Œè©ã‚’èª­ã¿è¿”ã—ãŸã ã‚ã†ã€ MVè¡£è£…", "ã€Œæ²¹ã‚’æ³¨ã›!ã€ MVè¡£è£…", "ã€Œè‡ªæ¥­è‡ªå¾—ã€MVè¡£è£…", "ã€Œæ„›ã—åˆã„ãªã•ã„ã€ MVè¡£è£…", "ã€Œå¼•ãã“ã‚‚ã‚‹æ™‚é–“ã¯ãªã„ã€ MVè¡£è£…", "ã€ŒI want tomorrow to comeã€MVè¡£è£…", "ã€Œæœ¬è³ªçš„ãªã“ã¨ã€ MVè¡£è£…", "ã€Œåƒ•ã¯åƒ•ã‚’å¥½ãã«ãªã‚Œãªã„ã€ MVè¡£è£…", "ã€ŒUDAGAWA GENERATIONã€MVè¡£è£…", "ã€ŒNothing Specialã€MVè¡£è£…", "ã€ŒNightmare ç—‡å€™ç¾¤ã€MVè¡£è£…", "ã€ŒAddictionã€ MVè¡£è£…", "ã€ŒMake or Breakã€ MVè¡£è£…", "ã€Œæ¸¯åŒºãƒ‘ã‚»ãƒªã€ MVè¡£è£…", "ã€Œæ­»ã‚“ã ãµã‚Šã€MVè¡£è£…", "ã€ŒUnhappy birthdayæ§‹æ–‡ã€MVè¡£è£…", "ã€Œæœ¨æ¯ã‚‰ã—ã¯æ³£ã‹ãªã„ã€MVè¡£è£…", "ã€ŒAlter egoã€MVè¡£è£…", "ã€ŒThe growing up trainã€MVè¡£è£…"], "å°é¢": ["æµã‚Œå¼¾ã‚¸ãƒ£ã‚±ãƒƒãƒˆå†™çœŸè¡£è£…", "ã€ŒStart over!ã€ ã‚¸ãƒ£ã‚±ãƒƒãƒˆå†™çœŸè¡£è£…", "ã€Œæ‰¿èªæ¬²æ±‚ã€ã‚¸ãƒ£ã‚±ãƒƒãƒˆå†™çœŸè¡£è£…", "ã€Œä½•æ­³ã®é ƒã«æˆ»ã‚ŠãŸã„ã®ã‹?ã€ã‚¸ãƒ£ã‚±ãƒƒãƒˆå†™çœŸè¡£è£…", "ã€Œè‡ªæ¥­è‡ªå¾—ã€ã‚¸ãƒ£ã‚±ãƒƒãƒˆå†™çœŸè¡£è£…", "ã€ŒI want tomorrow to comeã€ã‚¸ãƒ£ã‚±ãƒƒãƒˆå†™çœŸè¡£è£…", "ã€ŒUDAGAWA GENERATIONã€ã‚¸ãƒ£ã‚±ãƒƒãƒˆå†™çœŸè¡£è£…", "ã€ŒMake or Breakã€ã‚¸ãƒ£ã‚±ãƒƒãƒˆå†™çœŸè¡£è£…", "ã€ŒUnhappy birthdayæ§‹æ–‡ã€ã‚¸ãƒ£ã‚±ãƒƒãƒˆå†™çœŸè¡£è£…", "ã€ŒThe growing up trainã€ã‚¸ãƒ£ã‚±ãƒƒãƒˆå†™çœŸè¡£è£…"], "LIVEè¡£è£": ["ä¸‰æœŸç”Ÿãƒ–ãƒƒã‚¯ãƒ¬ãƒƒãƒˆè¡£è£…", "ã€Œ3rd TOUR 2023ã€ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°è¡£è£…", "ã€Œ3rd TOUR 2023ã€ç™½ã‚¹ãƒ¼ãƒ„è¡£è£…", "2023å¹´å¤ãƒ•ã‚§ã‚¹è¡£è£…", "ã€Œ3rd Single BACKS LIVE!!ã€è¡£è£…", "ã€Œ3rd TOUR 2023ã€ãƒ”ãƒ³ã‚¯è¡£è£…", "ã€Œ3rd YEAR ANNIVERSARY LIVEã€ãƒ©ã‚¤ãƒ–è¡£è£…", "ã€Œ7th Single BACKS LIVE!!ã€ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°è¡£è£…", "ã€Œå°æ—ç”±ä¾ å’æ¥­ã‚³ãƒ³ã‚µãƒ¼ãƒˆã€ãƒ©ã‚¤ãƒ–è¡£è£…", "ã€Œå°æ—ç”±ä¾ å’æ¥­ã‚³ãƒ³ã‚µãƒ¼ãƒˆã€èµ¤è¡£è£…", "ã€Œ3rd TOUR 2023ã€ãƒ©ã‚¤ãƒ–è¡£è£…", "2023å¹´ å¹´æœ«æ­Œå”±è¡£è£…", "ã€Œ8th Single BACKS LIVE!!ã€ãƒ©ã‚¤ãƒ–è¡£è£…", "ã€Œ4th ARENA TOUR 2024ã€ãƒ©ã‚¤ãƒ–è¡£è£…", "ã€Œ3rd YEAR ANNIVERSARY LIVEã€ãƒ©ã‚¤ãƒ–è¡£è£…", "ã€Œ4th ARENA TOUR IN æ±äº¬ãƒ‰ãƒ¼ãƒ ã€ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°è¡£è£…", "ã€Œ9th Single BACKS LIVE!!ã€ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°è¡£è£…", "2023å¹´ å¹´æœ«è¡£è£…", "2024å¹´å¤ãƒ•ã‚§ã‚¹è¡£è£…", "ã€Œ4th ARENA TOURã€ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°è¡£è£…", "ã€Œ4th YEAR ANNIVERSARY LIVEã€ãƒ©ã‚¤ãƒ–è¡£è£…", "ã€Œ4th ARENA TOURã€ãƒ©ã‚¤ãƒ–è¡£è£…", "ã€Œä¸‰æœŸç”Ÿãƒ©ã‚¤ãƒ–ã€ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°è¡£è£…", "ã€Œ4th ARENA TOUR IN æ±äº¬ãƒ‰ãƒ¼ãƒ ã€ãƒ©ã‚¤ãƒ–è¡£è£…", "ã€Œ10th Single BACKS LIVE!!ã€ãƒ©ã‚¤ãƒ–è¡£è£…", "ã€Œ5th TOUR 2025 â€œAddictionâ€ã€ãƒ©ã‚¤ãƒ–è¡£è£…", "ã€Œä¸‰æœŸç”Ÿãƒ©ã‚¤ãƒ–ã€è¡£è£…", "ã€Œ12th Single BACKS LIVE!!ã€ãƒ©ã‚¤ãƒ–è¡£è£…", "ã€Œ5th TOUR 2025 â€œAddictionâ€ã€é»‘è¡£è£…", "ã€Œ12th Single BACKS LIVE!!ã€é»‘è¡£è£…"], "å…¶ä»–": ["2023å¹´ å†¬ç§æœã‚³ãƒ¼ãƒ‡", "ã‚¹ãƒ¼ãƒ„ã‚³ãƒ¼ãƒ‡", "ã‚«ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‡", "ã‚µãƒãƒ¼ãƒ¯ãƒ³ãƒ”ãƒ¼ã‚¹", "ãƒ‡ãƒ‹ãƒ ã‚³ãƒ¼ãƒ‡", "2023å¹´ ãƒãƒ­ã‚¦ã‚£ãƒ³è¡£è£…", "2023å¹´ ã‚¯ãƒªã‚¹ãƒã‚¹ã‚µãƒ³ã‚¿è¡£è£…", "2023å¹´ èª­æ›¸ã‚³ãƒ¼ãƒ‡", "2024å¹´ æŒ¯è¢–è¡£è£…", "ãŠã†ã¡ã‚³ãƒ¼ãƒ‡", "ã‚¸ãƒ£ãƒ³ãƒ—ã‚¹ãƒ¼ãƒ„", "2024å¹´ æ˜¥ç§æœã‚³ãƒ¼ãƒ‡", "ã‚«ãƒ©ãƒ¼ãƒ‡ãƒ‹ãƒ ", "2024å¹´æµ´è¡£", "éº¥ã‚ã‚‰å¸½å­ã‚³ãƒ¼ãƒ‡", "Tã‚·ãƒ£ãƒ„ã‚³ãƒ¼ãƒ‡", "ãƒ¯ã‚¤ã‚·ãƒ£ãƒ„ã‚³ãƒ¼ãƒ‡", "2024å¹´ ãƒãƒ­ã‚¦ã‚£ãƒ³è¡£è£…", "ã‚«ãƒ©ãƒ¼ãƒ‹ãƒƒãƒˆã‚³ãƒ¼ãƒ‡", "2024å¹´ ã‚¯ãƒªã‚¹ãƒã‚¹ã‚µãƒ³ã‚¿è¡£è£…", "ã©ã†ã¶ã¤ç€ãã‚‹ã¿", "ãƒãƒ•ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‡", "2025å¹´æŒ¯è¢–", "ã„ã¬ã¿ã¿ã‚³ãƒ¼ãƒ‡", "ãƒ¢ãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡", "å†¬ç§æœã‚³ãƒ¼ãƒ‡", "ãƒã‚¯ã‚¿ã‚¤ã‚³ãƒ¼ãƒ‡", "ãƒ¬ã‚¶ãƒ¼ã‚¸ãƒ£ã‚±ãƒƒãƒˆã‚³ãƒ¼ãƒ‡", "2025å¹´æµ´è¡£", "ãƒãƒ­ã‚·ãƒ£ãƒ„ã‚³ãƒ¼ãƒ‡", "ã‚¯ãƒ©ã‚·ãƒƒã‚¯ã‚³ãƒ¼ãƒ‡", "ãƒã‚§ãƒƒã‚¯ã‚³ãƒ¼ãƒ‡", "ãƒ‘ã‚¤ãƒ¬ãƒ¼ãƒ„è¡£è£…", "å†¬æœ", "2025å¹´ ã‚µãƒ³ã‚¿è¡£è£…", "ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°åˆ¶æœ", "2026å¹´ æŒ¯è¢–", "ã‚¸ãƒ£ãƒ¼ã‚¸", "2026å¹´ ãƒãƒ¬ãƒ³ã‚¿ã‚¤ãƒ³ã‚³ãƒ¼ãƒ‡"], "ç‰¹æ®Š": ["ã€ä¼šå ´äºˆç´„ç‰¹å…¸ã€‘ æ±äº¬ãƒ‰ãƒ¼ãƒ é™å®šæˆå“¡ç”Ÿå¯«çœŸ", "æ±äº¬ãƒ‰ãƒ¼ãƒ å®Œè³£å¾¡ç¦®ç´€å¿µ!! ãƒ©ã‚¤ãƒ–æœƒå ´æ’®ã‚ŠãŠã‚ã—ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ç”Ÿå¯«çœŸ", "ç¦è¢‹ 2025 ã€Œ4th ARENA TOUR IN æ±äº¬ãƒ‰ãƒ¼ãƒ ã€ ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°è¡£è£…", "ç¦è¢‹ 2026 MVè¡£è£…"]},

          newItem: { name: '', series: '', category: '' },
          rawItems: [],
          ownedIds: new Set(),
          seriesImages: {},
          seriesOrder: {},

          expandedSeries: new Set(),
          expandedSeriesMode: new Set(),
          collapsedMemberCats: new Set(),
          collapsedSeriesCats: new Set(),
          collapsedMemberListCats: new Set(),
          seriesMemberFilter: new Set(), 
          showSeriesFilter: false, 

          zoomedImg: null,
        };
      },
      computed: {
        memberList() {
          return Array.from(
            new Set(this.rawItems.map(function (i) { return i.name; }))
          );
        },
        memberOrderMap() {
          var map = {};
          var idx = 0;
          var self = this;
          Object.keys(this.presetMembers).forEach(function (gen) {
            self.presetMembers[gen].forEach(function (name) {
              if (map[name] == null) map[name] = idx++;
            });
          });
          return map;
        },

        itemsBySeriesNormalized() {
          var grouped = {};
          var self = this;
          this.rawItems.forEach(function (item) {
            var cat = item.category || 'å…¶ä»–';
            if (!grouped[cat]) grouped[cat] = {};
            if (!grouped[cat][item.series]) grouped[cat][item.series] = [];
            var batches = grouped[cat][item.series];
            var batch = null;
            for (var i = 0; i < batches.length; i++) {
              if (batches[i].batchId === item.batchId) {
                batch = batches[i];
                break;
              }
            }
            if (!batch) {
              batch = {
                batchId: item.batchId,
                seriesName: item.series,
                memberName: item.name,
                items: [],
                totalSets: 1,
                groupIndex: 1,
              };
              batches.push(batch);
            }
            batch.items.push(item);
          });

          Object.keys(grouped).forEach((cat) => {
            var seriesMap = grouped[cat];
            Object.keys(seriesMap).forEach((s) => {
              var batches = seriesMap[s];
              var perMember = {};
              batches.forEach(function (batch) {
                if (!perMember[batch.memberName]) perMember[batch.memberName] = [];
                perMember[batch.memberName].push(batch);
              });
              Object.keys(perMember).forEach(function (m) {
                var list = perMember[m];
                list.sort(function (a, b) {
                  return String(a.batchId).localeCompare(String(b.batchId));
                });
                var total = list.length;
                list.forEach(function (batch, idx) {
                  batch.totalSets = total;
                  batch.groupIndex = idx + 1;
                });
              });
              batches.sort(function (a, b) {
                var ao = (self.memberOrderMap[a.memberName] != null
                  ? self.memberOrderMap[a.memberName]
                  : 9999);
                var bo = (self.memberOrderMap[b.memberName] != null
                  ? self.memberOrderMap[b.memberName]
                  : 9999);
                if (ao !== bo) return ao - bo;
                return String(a.memberName).localeCompare(String(b.memberName), 'ja');
              });
            });
          });

          return grouped;
        },

        itemsBySeriesSorted() {
          var result = {};
          var base = this.itemsBySeriesNormalized;
          var self = this;

          Object.keys(base).forEach(function (cat) {
            var seriesObj = base[cat];
            var baseOrder = self.categorizedSeries[cat] || [];
            var customOrder = self.seriesOrder[cat] || [];
            var seen = {};
            var finalOrder = [];

    // ğŸ”½ æˆå“¡ç¯©é¸ï¼ˆä¾å·²é¸æˆå“¡éš±è—ä¸ç¬¦åˆçš„ç³»åˆ—ï¼‰
    if (self.seriesMemberFilter && self.seriesMemberFilter.size) {
      var filtered = {};
      Object.keys(seriesObj).forEach(function (seriesName) {
        var batches = seriesObj[seriesName];
        var hasMatch = batches.some(function (b) {
          return self.seriesMemberFilter.has(b.memberName);
        });
        if (hasMatch) {
          filtered[seriesName] = batches;
        }
      });
      seriesObj = filtered;
    }

            baseOrder.forEach(function (name) {
              if (seriesObj[name]) {
                finalOrder.push(name);
                seen[name] = true;
              }
            });

            customOrder.forEach(function (name) {
              if (seriesObj[name] && !seen[name]) {
                finalOrder.push(name);
                seen[name] = true;
              }
            });

            Object.keys(seriesObj).forEach(function (name) {
              if (!seen[name]) {
                finalOrder.push(name);
                seen[name] = true;
              }
            });

            var sortedSeries = {};
            finalOrder.forEach(function (name) {
              sortedSeries[name] = seriesObj[name];
            });
            result[cat] = sortedSeries;
          });

          return result;
        },

        memberItemsGrouped() {
          if (!this.currentMember) return [];

          var groupedMap = {};
          var self = this;

          this.rawItems
            .filter((i) => i.name === this.currentMember)
            .forEach(function (item) {
              var cat = item.category || 'å…¶ä»–';
              if (!groupedMap[cat]) {
                groupedMap[cat] = { category: cat, items: [] };
              }
              var list = groupedMap[cat].items;
              var batch = null;
              for (var i = 0; i < list.length; i++) {
                if (list[i].batchId === item.batchId) {
                  batch = list[i];
                  break;
                }
              }
              if (!batch) {
                batch = {
                  batchId: item.batchId,
                  seriesName: item.series,
                  items: [],
                  totalSets: 1,
                  groupIndex: 1,
                };
                list.push(batch);
              }
              batch.items.push(item);
            });

          Object.keys(groupedMap).forEach(function (cat) {
            var catBlock = groupedMap[cat];
            var perSeries = {};
            catBlock.items.forEach(function (batch) {
              if (!perSeries[batch.seriesName]) perSeries[batch.seriesName] = [];
              perSeries[batch.seriesName].push(batch);
            });
            Object.keys(perSeries).forEach(function (seriesName) {
              var list = perSeries[seriesName];
              list.sort(function (a, b) {
                return String(a.batchId).localeCompare(String(b.batchId));
              });
              var total = list.length;
              list.forEach(function (batch, idx) {
                batch.totalSets = total;
                batch.groupIndex = idx + 1;
              });
            });
          });

          var result = [];
          var categoryBaseOrder = ['å°å…¥', 'MVè¡£è£', 'å°é¢ç…§', 'LIVEè¡£è£', 'å…¶ä»–'];
          var cats = Object.keys(groupedMap);

          cats.sort(function (a, b) {
            var ai = categoryBaseOrder.indexOf(a);
            var bi = categoryBaseOrder.indexOf(b);
            var av = ai === -1 ? 999 : ai;
            var bv = bi === -1 ? 999 : bi;
            if (av !== bv) return av - bv;
            return String(a).localeCompare(String(b), 'zh-Hant');
          });

          cats.forEach(function (cat) {
            var block = groupedMap[cat];
            var baseOrder = self.categorizedSeries[cat] || [];
            var seen = {};
            var sortedItems = [];

            baseOrder.forEach(function (seriesName) {
              block.items.forEach(function (batch) {
                if (
                  batch.seriesName === seriesName &&
                  !seen[batch.batchId]
                ) {
                  sortedItems.push(batch);
                  seen[batch.batchId] = true;
                }
              });
            });

            block.items.forEach(function (batch) {
              if (!seen[batch.batchId]) {
                sortedItems.push(batch);
                seen[batch.batchId] = true;
              }
            });

            result.push({
              category: cat,
              items: sortedItems,
            });
          });

          return result;
        },
      },
      async mounted() {
        try {
          const r = await get('raw_items');
          const o = await get('owned_photos');
          const s = await get('series_images');
          const so = await get('series_order');
          if (r && Array.isArray(r)) this.rawItems = r;
          if (o && Array.isArray(o)) this.ownedIds = new Set(o);
          if (s && typeof s === 'object' && s) this.seriesImages = s;
          if (so && typeof so === 'object' && so) this.seriesOrder = so;
        } catch (e) {
          console.error('è¼‰å…¥è³‡æ–™éŒ¯èª¤ï¼š', e);
        }

        window.addEventListener('scroll', this.handleScroll, {
          passive: true,
        });
      },
      unmounted() {
        window.removeEventListener('scroll', this.handleScroll);
      },
      methods: {
        async saveData() {
          try {
            localStorage.setItem(
              'sakura_txt',
              JSON.stringify({
                rawItems: this.rawItems,
                ownedIds: Array.from(this.ownedIds),
                seriesImages: this.seriesImages,
                seriesOrder: this.seriesOrder,
              })
            );
          } catch (e) {
            console.error('localStorage å‚™ä»½éŒ¯èª¤ï¼š', e);
          }

          try {
            await set('raw_items', this.rawItems);
            await set('owned_photos', Array.from(this.ownedIds));
            await set('series_images', this.seriesImages);
            await set('series_order', this.seriesOrder);
          } catch (e) {
            console.error('å„²å­˜è³‡æ–™éŒ¯èª¤ï¼š', e);
          }
        },

        importData(event) {
          const file = event.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = async (e) => {
            try {
              const text = e.target.result;
              const data = JSON.parse(text);

              this.rawItems = Array.isArray(data.rawItems) ? data.rawItems : [];
              this.ownedIds = new Set(
                Array.isArray(data.ownedIds) ? data.ownedIds : []
              );
              this.seriesImages =
                data.seriesImages && typeof data.seriesImages === 'object'
                  ? data.seriesImages
                  : {};
              this.seriesOrder =
                data.seriesOrder && typeof data.seriesOrder === 'object'
                  ? data.seriesOrder
                  : {};

              await this.saveData();
              alert('åŒ¯å…¥å®Œæˆï¼');
            } catch (err) {
              console.error('åŒ¯å…¥å¤±æ•—ï¼š', err);
              alert('åŒ¯å…¥å¤±æ•—ï¼Œæª”æ¡ˆæ ¼å¼å¯èƒ½ä¸æ­£ç¢ºã€‚');
            } finally {
              event.target.value = '';
            }
          };
          reader.readAsText(file);
        },

        onCategorySelect() {
          if (this.selectedCategory !== 'custom_cat') {
            this.newItem.category = this.selectedCategory;
          }
          this.selectedPreset = '';
        },
        onSeriesSelect() {
          if (this.selectedPreset !== 'custom_series') {
            this.newItem.series = this.selectedPreset;
          }
        },

        getUniqueMemberCount(batches) {
          return Array.from(
            new Set(batches.map(function (b) { return b.memberName; }))
          ).length;
        },
        getMemberOwnedCount(name) {
          return this.rawItems.filter(
            (i) => i.name === name && this.ownedIds.has(i.id)
          ).length;
        },
        getProgress(items) {
          return {
            count: items.filter((i) => this.ownedIds.has(i.id)).length,
          };
        },
        getActiveMembersInGen(gen) {
          var self = this;
          return this.presetMembers[gen].filter(function (name) {
            return self.memberList.indexOf(name) !== -1;
          });
        },
        getGenActiveCount(gen) {
          return this.getActiveMembersInGen(gen).length;
        },

        toggleSeries(id) {
          if (this.expandedSeries.has(id)) this.expandedSeries.delete(id);
          else this.expandedSeries.add(id);
        },
        toggleSeriesMode(cat, sName) {
          const key = cat + sName;
          if (this.expandedSeriesMode.has(key))
            this.expandedSeriesMode.delete(key);
          else this.expandedSeriesMode.add(key);
        },
        toggleCategoryMember(cat) {
          if (this.collapsedMemberCats.has(cat))
            this.collapsedMemberCats.delete(cat);
          else this.collapsedMemberCats.add(cat);
        },
        toggleCategorySeries(cat) {
          if (this.collapsedSeriesCats.has(cat))
            this.collapsedSeriesCats.delete(cat);
          else this.collapsedSeriesCats.add(cat);
        },
        toggleMemberListCat(gen) {
          if (this.collapsedMemberListCats.has(gen))
            this.collapsedMemberListCats.delete(gen);
          else this.collapsedMemberListCats.add(gen);
        },

        async toggleItem(id) {
          if (this.ownedIds.has(id)) this.ownedIds.delete(id);
          else this.ownedIds.add(id);
          await this.saveData();
        },

        async removeSeries(bId) {
          if (!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
          this.rawItems = this.rawItems.filter((i) => i.batchId !== bId);
          delete this.seriesImages[bId];
          await this.saveData();
        },
        async removeImage(bId) {
          if (!confirm('åˆªé™¤åœ–ç‰‡ï¼Ÿ')) return;
          delete this.seriesImages[bId];
          await this.saveData();
        },

        async handleSeriesImageUpload(event, bId) {
          const file = event.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = async () => {
              const canvas = document.createElement('canvas');
              const MAX_WIDTH = 800;
              const ratio = MAX_WIDTH / img.width;
              canvas.width = MAX_WIDTH;
              canvas.height = img.height * ratio;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
              this.seriesImages[bId] = canvas.toDataURL('image/jpeg', 0.5);
              await this.saveData();
            };
            img.src = e.target.result;
          };
          reader.readAsDataURL(file);
        },

        async addBatchItems() {
          // 1. å…ˆç¢ºèªæˆå“¡
          const names =
            this.addMode === 'member'
              ? (this.newItem.name ? [this.newItem.name] : [])
              : this.batchMemberNames;

          if (!names.length) {
            alert('è«‹å…ˆé¸æ“‡æˆå“¡ï¼ˆæˆ–å‹¾é¸è‡³å°‘ä¸€ä½æˆå“¡ï¼‰');
            return;
          }

          if (!this.newItem.category) {
            alert('è«‹å…ˆé¸æ“‡ã€Œåˆ†é¡ã€');
            return;
          }

          if (!this.newItem.series) {
            alert('è«‹å…ˆé¸æ“‡ã€Œç³»åˆ—ã€æˆ–è¼¸å…¥è‡ªè¨‚ç³»åˆ—åç¨±');
            return;
          }

          if (!this.seriesOrder[this.newItem.category]) {
            this.seriesOrder[this.newItem.category] = [];
          }
          if (
            this.seriesOrder[this.newItem.category].indexOf(this.newItem.series) === -1
          ) {
            this.seriesOrder[this.newItem.category].push(this.newItem.series);
          }

          const self = this;
          names.forEach(function (name) {
            const bId =
              'b-' + Date.now() + Math.random().toString(36).slice(2, 7);
            ['ãƒ¨ãƒª', 'ãƒãƒ¥ã‚¦', 'ãƒ’ã‚­', 'åº§ã‚Š'].forEach(function (type) {
              self.rawItems.push({
                id: Math.random().toString(36).slice(2, 11),
                batchId: bId,
                name: name,
                series: self.newItem.series,
                category: self.newItem.category,
                type: type,
              });
            });
          });

          await this.saveData();
          this.showInput = false;
          this.batchMemberNames = [];

          if (this.addMode === 'member' && names.length === 1) {
            this.currentMember = names[0];
          }
        },

        async exportData() {
          const data = {
            rawItems: this.rawItems,
            ownedIds: Array.from(this.ownedIds),
            seriesImages: this.seriesImages,
            seriesOrder: this.seriesOrder,
          };
          const blob = new Blob([JSON.stringify(data)], {
            type: 'text/plain',
          });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = 'sakura_backup.txt';
          a.click();
        },

        async clearAll() {
          if (!confirm('æ¸…ç©ºæ‰€æœ‰è³‡æ–™ï¼Ÿ')) return;
          try {
            await clear();
          } catch (e) {
            console.error('æ¸…ç©ºå„²å­˜å¤±æ•—ï¼š', e);
          }
          localStorage.removeItem('sakura_txt');
          location.reload();
        },

        handleScroll() {
          const y =
            window.scrollY || window.pageYOffset || document.documentElement.scrollTop || 0;
          this.scrollY = y;
          this.showScrollTop =
            y > 300 && this.viewMode === 'series' && !this.currentMember;
        },
        scrollToTop() {
          window.scrollTo({ top: 0, behavior: 'smooth' });
        },
      },
    }).mount('#app');
  </script>
</body>
</html>
